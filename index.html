<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Desafio dos 60 Segundos üß†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Script principal do Google AdSense -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9968425306160320"
          crossorigin="anonymous"></script>
  
  <style>
    body {
      font-family: 'Arial', sans-serif; /* Fonte mais comum e limpa */
      display: flex;
      flex-direction: column;
      align-items: center; /* Centraliza o conte√∫do horizontalmente */
      justify-content: flex-start; /* Alinha o conte√∫do ao topo, permitindo que ele flua */
      min-height: 100vh;
      margin: 0;
      /* Fundo com gradiente vibrante que ficar√° atr√°s dos "cards" */
      background: linear-gradient(135deg, #7ed6df 0%, #4CAF50 100%); /* Azul claro para verde */
      color: #333;
      padding: 15px; /* Padding geral para o body, para que o conte√∫do n√£o cole nas bordas */
      box-sizing: border-box;
      overflow-x: hidden; /* Evita rolagem horizontal */
    }

    h1 { /* Este H1 n√£o ser√° mais usado, o t√≠tulo estar√° no menu principal */
      display: none; 
    }

    /* Anima√ß√£o de entrada para os cont√™ineres principais */
    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.95) translateY(20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    /* Anima√ß√£o de pulso para feedback de score/tempo */
    @keyframes pulseEffect {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    /* Anima√ß√£o de shake para barra de tempo */
    @keyframes timeShake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
        20%, 40%, 60%, 80% { transform: translateX(2px); }
    }

    /* Anima√ß√£o de fade para splash screen */
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; display: none; }
    }

    /* Anima√ß√£o para os s√≠mbolos matem√°ticos (dan√ßando) */
    @keyframes danceSymbols {
        0%, 100% { transform: translateY(0) rotate(0deg); }
        25% { transform: translateY(-5px) rotate(5deg); }
        50% { transform: translateY(0) rotate(-5deg); }
        75% { transform: translateY(-3px) rotate(3deg); }
    }


    /* Telas principais: Splash, Menu, Sele√ß√£o de Modo, Jogo, Rankings */
    /* Agora usam flexbox e margin: auto para centraliza√ß√£o e respeitar o padding do body */
    #main-menu, #operation-selection-container, #mode-selection-container, #game-container {
        background-color: #ffffff; /* Fundo branco limpo para os cards */
        padding: 30px;
        border-radius: 15px; /* Cantos mais arredondados */
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); /* Sombra mais pronunciada */
        width: 95%; /* Ocupa 95% da largura dispon√≠vel */
        max-width: 400px; /* Limita a largura em telas grandes para a maioria dos cards */
        margin: 15px auto; /* Centraliza horizontalmente e d√° margem vertical */
        position: relative; /* Para posicionamento interno, como o √≠cone de configura√ß√µes */
        overflow: hidden;
        display: none; /* Por padr√£o, oculto */
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-sizing: border-box;
        text-align: center; /* Centraliza o texto dentro dos cards */
    }

    /* Ranking container principal e Competi√ß√£o Mode container tem uma max-width maior */
    #rankings-container, #competition-mode-selection-container {
        background-color: #ffffff; /* Fundo branco limpo para os cards */
        padding: 30px;
        border-radius: 15px; /* Cantos mais arredondados */
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2); /* Sombra mais pronunciada */
        width: 95%; /* Ocupa 95% da largura dispon√≠vel */
        max-width: 800px; /* Maior largura para o ranking e competi√ß√£o */
        margin: 15px auto; /* Centraliza horizontalmente e d√° margem vertical */
        position: relative; /* Para posicionamento interno, como o √≠cone de configura√ß√µes */
        overflow: hidden;
        display: none; /* Por padr√£o, oculto */
        flex-direction: column; /* Sempre em coluna */
        align-items: center; /* Centraliza os itens */
        justify-content: space-between; /* Espa√ßo entre os itens (listas e bot√£o) */
        box-sizing: border-box;
        text-align: center; /* Centraliza o texto dentro dos cards */
    }


    /* Splash screen permanece fixa para cobrir tudo inicialmente */
    #splash-screen {
        position: fixed; /* Usa fixed para garantir que cobre toda a viewport */
        top: 0;
        left: 0;
        width: 100vw; /* Usa a largura da viewport */
        height: 100vh; /* Usa a altura da viewport */
        background: linear-gradient(45deg, #4CAF50 0%, #28a745 100%); /* Gradiente verde vibrante */
        color: white;
        font-size: 4em; /* Fonte maior */
        font-weight: bold;
        text-shadow: 3px 3px 6px rgba(0,0,0,0.4); /* Sombra mais forte */
        display: none; /* Inicia oculto, JS ativa */
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1000; /* Alto z-index para garantir que esteja no topo */
    }
    #splash-screen.active {
        display: flex; /* Mostra a splash screen */
        opacity: 1; /* Garante opacidade 1 quando ativa */
    }
    #splash-screen.fade-out {
        animation: fadeOut 0.5s forwards;
    }

    /* Classe 'active' para as outras telas */
    #main-menu.active, #operation-selection-container.active, #mode-selection-container.active, #game-container.active, #rankings-container.active, #competition-mode-selection-container.active {
        display: flex; /* Mostra como flex quando ativa */
        animation: fadeInScale 0.7s ease-out forwards; /* Anima√ß√£o de entrada */
    }
    
    /* Estilo espec√≠fico da Splash Screen */
    #splash-screen .brain-icon {
        font-size: 5em; /* Tamanho do c√©rebro */
        margin-bottom: 10px;
        animation: pulseEffect 1.5s infinite alternate; /* Anima√ß√£o de pulso para o c√©rebro */
    }
    #splash-screen .splash-text {
        font-size: 1.5em; /* Tamanho do texto "60 Segundos" */
        font-weight: normal;
        text-align: center; /* Centraliza o texto */
        line-height: 1.2; /* Ajusta o espa√ßamento entre linhas */
    }

    /* Novo estilo para o t√≠tulo do menu principal */
    .main-title-box {
        background: linear-gradient(45deg, #4CAF50 0%, #28a745 100%); /* Fundo verde */
        border-radius: 20px; /* Cantos arredondados */
        padding: 20px 30px;
        margin-bottom: 40px; /* Espa√ßo abaixo do t√≠tulo */
        display: flex;
        flex-direction: column;
        align-items: center;
        box-shadow: 0 8px 16px rgba(0,0,0,0.3); /* Sombra para destacar */
        color: white;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        width: 90%; /* Ajusta a largura */
        max-width: 300px; /* Limita a largura */
    }

    .main-title-box .brain-icon-title {
        font-size: 4em; /* Tamanho do c√©rebro no t√≠tulo */
        margin-bottom: 10px;
    }

    .main-title-box .title-text {
        font-size: 2em; /* Tamanho do texto */
        font-weight: bold;
        line-height: 1.2; /* Espa√ßamento entre linhas */
    }


    #main-menu .math-symbols {
        font-size: 5.5em; /* S√≠mbolos ainda maiores */
        color: #ffeb3b; /* Amarelo vibrante */
        margin-bottom: 50px;
        font-weight: bold;
        letter-spacing: 10px; /* Mais espa√ßamento */
        text-shadow: 3px 3px 6px rgba(0,0,0,0.4);
        display: flex;
        gap: 15px; /* Espa√ßamento entre os s√≠mbolos */
    }
    #main-menu .math-symbols span {
        display: inline-block;
        animation: danceSymbols 2s infinite ease-in-out alternate; /* Anima√ß√£o de dan√ßa */
    }
    #main-menu .math-symbols span:nth-child(1) { animation-delay: 0s; }
    #main-menu .math-symbols span:nth-child(2) { animation-delay: 0.2s; }
    #main-menu .math-symbols span:nth-child(3) { animation-delay: 0.4s; }
    #main-menu .math-symbols span:nth-child(4) { animation-delay: 0.6s; }

    #main-menu .menu-buttons {
        display: flex;
        flex-direction: column;
        gap: 25px; /* Mais espa√ßamento entre os bot√µes */
        width: 80%; /* Bot√µes um pouco mais largos */
        max-width: 350px; /* Limite de largura para os bot√µes */
    }
    #main-menu .menu-buttons button {
        padding: 20px 40px; /* Padding maior */
        font-size: 2em; /* Fonte maior */
        border-radius: 15px; /* Cantos mais arredondados */
        background: linear-gradient(45deg, #ff9800 0%, #fb8c00 100%); /* Laranja vibrante */
        color: white;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 8px 16px rgba(0,0,0,0.3); /* Sombra mais forte */
    }
    #main-menu .menu-buttons button:hover {
        transform: translateY(-7px); /* Efeito de eleva√ß√£o maior */
        box-shadow: 0 12px 25px rgba(0,0,0,0.4); /* Sombra maior no hover */
        background: linear-gradient(45deg, #fb8c00 0%, #ff9800 100%); /* Gradiente invertido no hover */
    }
    #main-menu .menu-buttons button:active {
        transform: translateY(0);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    /* Estilos para a sele√ß√£o de opera√ß√£o e competi√ß√£o */
    #operation-selection-container h3, #competition-mode-selection-container h3 {
        color: #333;
        font-size: 1.8em;
        margin-bottom: 25px;
    }
    #operation-selection-container .operation-buttons, #competition-mode-selection-container .competition-buttons {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* Duas colunas */
        gap: 15px;
        width: 100%;
        margin-bottom: 20px;
    }
    #operation-selection-container .operation-buttons button, #competition-mode-selection-container .competition-buttons button {
        padding: 15px 20px;
        font-size: 1.2em;
        border-radius: 10px;
        background: linear-gradient(45deg, #007bff 0%, #0056b3 100%);
        color: white;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    #operation-selection-container .operation-buttons button:hover, #competition-mode-selection-container .competition-buttons button:hover {
        background: linear-gradient(45deg, #0056b3 0%, #007bff 100%);
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }
    #operation-selection-container .operation-buttons button.active, #competition-mode-selection-container .competition-buttons button.active {
        background: linear-gradient(45deg, #4CAF50 0%, #218838 100%); /* Verde quando ativo */
        box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.6); /* Anel verde mais forte */
    }

    /* CONTAINER PARA OS RANKINGS EMBUTIDOS NA TELA DE COMPETI√á√ÉO */
    #embedded-rankings-area {
        display: flex; /* Habilita flexbox */
        flex-direction: column; /* Colunas por padr√£o (para mobile) */
        gap: 20px; /* Espa√ßo entre os rankings */
        width: 100%; /* Ocupa a largura total do container pai */
        margin-top: 25px; /* Espa√ßo acima dos rankings */
        align-items: center; /* Centraliza os itens */
    }

    #embedded-rankings-area .ranking-section {
        flex: 1; /* Faz com que cada ranking ocupe o mesmo espa√ßo dispon√≠vel */
        margin-bottom: 0; /* Remove margem inferior individual, a margem est√° no gap do container */
        max-width: none; /* Remove a max-width individual para que possam se expandir */
        width: auto; /* Permite que o flexbox controle a largura */
        
        /* NOVO: Fundo verde e cantos arredondados para os rankings embutidos */
        background: linear-gradient(45deg, #28a745 0%, #218838 100%); /* Verde mais escuro */
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        color: white; /* Texto branco para contraste */
    }

    #embedded-rankings-area .ranking-section h2 {
        font-size: 1.2em; /* Fonte menor para t√≠tulos de ranking embutido */
        margin-bottom: 10px;
        color: white; /* Garante que o t√≠tulo √© branco */
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }

    /* Ajustes para os itens da lista de ranking embutido */
    #embedded-rankings-area .ranking-list {
        background-color: rgba(255, 255, 255, 0.1); /* Fundo sutil para as listas */
        border-radius: 10px;
        padding: 10px;
    }
    #embedded-rankings-area .ranking-list li {
        padding: 8px 10px; /* Padding interno para as linhas */
        border-bottom: 1px solid rgba(255, 255, 255, 0.2); /* Borda mais clara */
        background-color: transparent; /* Garante que a cor de fundo da li n√£o sobreponha a do ranking-list */
        transition: background-color 0.3s ease; /* Transi√ß√£o suave para hover */
    }
    #embedded-rankings-area .ranking-list li:last-child {
        border-bottom: none;
    }
    #embedded-rankings-area .ranking-list li:hover {
        background-color: rgba(255, 255, 255, 0.15); /* Efeito de hover */
    }

    /* Cores para os Top 3 no ranking embutido (fundo da linha e texto) */
    #embedded-rankings-area .ranking-list li.ranking-item-top {
        background-color: rgba(0, 123, 255, 0.3); /* Azul com transpar√™ncia */
        border: 1px solid #007bff; /* Borda azul */
    }
    #embedded-rankings-area .ranking-list li.ranking-item-top .ranking-position,
    #embedded-rankings-area .ranking-list li.ranking-item-top .ranking-name,
    #embedded-rankings-area .ranking-list li.ranking-item-top .ranking-level,
    #embedded-rankings-area .ranking-list li.ranking-item-top .ranking-score {
        color: white; /* Texto branco para contraste */
        font-weight: bold;
    }

    /* Cores para os 3 √öltimos no ranking embutido (fundo da linha e texto) */
    #embedded-rankings-area .ranking-list li.ranking-item-bottom {
        background-color: rgba(220, 53, 69, 0.3); /* Vermelho com transpar√™ncia */
        border: 1px solid #dc3545; /* Borda vermelha */
    }
    #embedded-rankings-area .ranking-list li.ranking-item-bottom .ranking-position,
    #embedded-rankings-area .ranking-list li.ranking-item-bottom .ranking-name,
    #embedded-rankings-area .ranking-list li.ranking-item-bottom .ranking-level,
    #embedded-rankings-area .ranking-list li.ranking-item-bottom .ranking-score {
        color: white; /* Texto branco para contraste */
        font-weight: bold;
    }


    #question-area {
      margin-bottom: 20px;
    }

    #difficulty-level {
        font-size: 1em; /* Um pouco maior */
        color: #555; /* Cor mais escura */
        margin-bottom: 10px;
        font-weight: bold;
    }

    #question {
      font-size: 2.5em; /* Pergunta maior */
      margin-bottom: 15px;
      color: #333; /* Cor mais escura */
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
      transition: color 0.3s ease, transform 0.3s ease; /* Transi√ß√£o para cor e posi√ß√£o */
    }

    #question.correct-animation {
        animation: pulseGreen 0.5s ease-out;
    }
    #question.incorrect-animation {
        animation: shakeRed 0.5s ease-out;
    }

    #answer-input, #player-name-input {
      padding: 15px; /* Padding maior */
      font-size: 1.5em; /* Fonte maior */
      width: calc(100% - 30px); /* Ajuste para padding */
      margin-bottom: 15px;
      border: 2px solid #ddd; /* Borda mais vis√≠vel */
      border-radius: 10px; /* Cantos mais arredondados */
      text-align: center;
      transition: border-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
      background-color: #f9f9f9; /* Fundo levemente cinza */
      /* Impede que o teclado virtual do sistema apare√ßa */
      -webkit-touch-callout: none; /* iOS Safari */
      -webkit-user-select: none; /* Safari */
      -khtml-user-select: none; /* Konqueror HTML */
      -moz-user-select: none; /* Old versions of Firefox */
      -ms-user-select: none; /* Internet Explorer/Edge */
      user-select: none; /* Non-prefixed version, currently supported by Chrome, Edge, Opera and Firefox */
    }

    #player-name-input {
        margin-bottom: 20px;
    }

    #answer-input.correct {
      border-color: #28a745;
      box-shadow: 0 0 8px rgba(40, 167, 69, 0.7); /* Sombra mais forte */
    }

    #answer-input.incorrect {
      border-color: #d9534f;
      box-shadow: 0 0 8px rgba(217, 83, 79, 0.7); /* Sombra mais forte */
    }

    #answer-input.correct-input-anim {
        animation: bounceIn 0.3s forwards;
    }
    #answer-input.incorrect-input-anim {
        animation: shake 0.5s ease-out;
    }

    button {
      background: linear-gradient(45deg, #007bff 0%, #0056b3 100%); /* Gradiente azul padr√£o */
      color: white;
      padding: 12px 25px;
      border: none;
      border-radius: 8px; /* Cantos mais arredondados */
      cursor: pointer;
      font-size: 1.1em;
      transition: all 0.3s ease; /* Transi√ß√£o suave para todas as propriedades */
      margin: 5px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Sombra padr√£o */
    }

    button:hover {
      background: linear-gradient(45deg, #0056b3 0%, #007bff 100%); /* Gradiente invertido no hover */
      transform: translateY(-3px); /* Eleva√ß√£o no hover */
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3); /* Sombra maior no hover */
    }

    button:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    /* Cores para bot√µes de sele√ß√£o de modo e dificuldade */
    .mode-button {
        background: linear-gradient(45deg, #6c757d 0%, #5a6268 100%); /* Gradiente cinza */
    }
    .mode-button.active {
        background: linear-gradient(45deg, #4CAF50 0%, #218838 100%); /* Gradiente verde quando ativo */
        box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.6); /* Anel verde mais forte */
    }
    .mode-button:hover {
        background: linear-gradient(45deg, #5a6268 0%, #6c757d 100%);
    }

    /* Bot√£o Voltar */
    .back-button {
        background: linear-gradient(45deg, #f44336 0%, #d32f2f 100%); /* Gradiente vermelho */
        margin-top: 30px !important; /* Mais espa√ßo acima */
        padding: 10px 20px;
        font-size: 1em;
    }
    .back-button:hover {
        background: linear-gradient(45deg, #d32f2f 0%, #f44336 100%);
    }

    #message {
      margin-top: 15px;
      font-weight: bold;
      opacity: 0; /* Sempre invis√≠vel */
      transition: none; /* Sem transi√ß√£o */
      font-size: 1.1em;
    }

    /* Remove todas as classes que controlam visibilidade e cor de mensagem */
    #message.show, #message.correct-text, #message.incorrect-text, #message.speed-bonus-text {
        opacity: 0;
        display: none; /* Garante que n√£o ocupa espa√ßo */
    }


    #timer, #score {
      font-size: 1.3em; /* Um pouco maior */
      margin: 10px 0;
      color: #555; /* Cor mais escura */
    }

    #timer-value, #score-value {
      font-weight: bold;
      color: #4CAF50;
      transition: color 0.3s ease; /* Transi√ß√£o para mudan√ßa de cor */
    }
    #timer-value.pulse-effect, #score-value.pulse-effect {
        animation: pulseEffect 0.3s ease-out;
    }


    #start-game-button {
      background: linear-gradient(45deg, #28a745 0%, #218838 100%); /* Gradiente verde */
      padding: 18px 35px; /* Padding maior */
      font-size: 1.5em; /* Fonte maior */
      border-radius: 12px; /* Cantos mais arredondados */
      box-shadow: 0 6px 12px rgba(0,0,0,0.25);
    }

    #start-game-button:hover {
      background: linear-gradient(45deg, #218838 0%, #28a745 100%);
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.35);
    }

    .ranking-section h2 {
      color: #4CAF50;
      margin-bottom: 15px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
    }

    .ranking-list {
      list-style: none;
      padding: 0;
      text-align: left;
      width: 100%; /* Ocupa a largura total do container */
      font-size: 0.9em; /* Fonte um pouco menor para o ranking */
    }

    .ranking-list li {
      padding: 8px 0; /* Menos padding */
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: nowrap; /* Impede quebra de linha para melhor alinhamento */
    }

    .ranking-list li:last-child {
      border-bottom: none;
    }

    .ranking-position {
      font-weight: bold;
      color: #007bff;
      min-width: 25px; /* Largura m√≠nima para posi√ß√£o */
      margin-right: 5px; /* Espa√ßo entre a posi√ß√£o e o nome */
      text-align: right; /* Alinha a posi√ß√£o √† direita */
    }

    .ranking-name {
      flex-grow: 1;
      margin-right: 5px; /* Espa√ßo entre nome e score */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #444;
    }

    .ranking-level {
        font-size: 0.8em; /* Um pouco menor */
        color: #777;
        margin-left: 5px; /* Espa√ßo ap√≥s o nome */
        white-space: nowrap;
        flex-shrink: 0; /* Impede que o n√≠vel encolha */
    }

    .ranking-score {
        font-weight: bold;
        color: #333;
        min-width: 45px; /* Largura m√≠nima para score */
        text-align: right;
        flex-shrink: 0; /* Impede que o score encolha */
    }

    #time-bar-container {
      width: 100%;
      height: 15px; /* Barra mais grossa */
      background-color: #ddd;
      border-radius: 8px; /* Cantos arredondados */
      margin-bottom: 15px;
      overflow: hidden;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); /* Sombra interna */
    }

    #time-bar {
      height: 100%;
      width: 100%;
      background-color: #4CAF50;
      border-radius: 8px;
      transition: width 0.9s linear, background-color 0.9s linear, transform 0.1s ease;
    }
    .time-bar-shaking {
        animation: timeShake 0.5s ease-out infinite;
    }

    /* Cores para os Top 3 no ranking principal (fundo da linha e texto) */
    .ranking-list li.ranking-item-top {
        background-color: rgba(0, 123, 255, 0.1); /* Azul claro com transpar√™ncia */
        border: 1px solid #007bff; /* Borda azul */
    }
    .ranking-list li.ranking-item-top .ranking-position,
    .ranking-list li.ranking-item-top .ranking-name,
    .ranking-list li.ranking-item-top .ranking-level,
    .ranking-list li.ranking-item-top .ranking-score {
        color: #007bff; /* Azul vibrante para o top 3 */
        font-weight: bold;
    }

    /* Cores para os 3 √öltimos no ranking principal (fundo da linha e texto) */
    .ranking-list li.ranking-item-bottom {
        background-color: rgba(220, 53, 69, 0.1); /* Vermelho claro com transpar√™ncia */
        border: 1px solid #dc3545; /* Borda vermelha */
    }
    .ranking-list li.ranking-item-bottom .ranking-position,
    .ranking-list li.ranking-item-bottom .ranking-name,
    .ranking-list li.ranking-item-bottom .ranking-level,
    .ranking-list li.ranking-item-bottom .ranking-score {
        color: #dc3545; /* Vermelho forte para o bottom 3 */
        font-weight: bold;
    }

    /* Teclado num√©rico */
    #numeric-keypad {
        display: grid;
        grid-template-columns: repeat(3, 1fr); /* 3 colunas de largura igual */
        gap: 15px; /* Aumento do espa√ßamento entre os bot√µes */
        width: 100%;
        max-width: 400px; /* Ajuste a largura m√°xima conforme necess√°rio para o layout de 3 colunas */
        margin-top: 30px; /* Mais espa√ßo acima */
        background-color: #e0e0e0; /* Fundo mais claro */
        padding: 20px; /* Mais padding */
        border-radius: 15px; /* Cantos mais arredondados */
        box-shadow: 0 4px 10px rgba(0,0,0,0.15); /* Sombra mais suave */
        display: none; /* Inicia oculto */
    }

    #numeric-keypad button {
        /* REMOVIDO: width: 100%; - Esta propriedade estava causando o empilhamento. */
        height: 70px; /* Altura dos bot√µes maior */
        font-size: 2em; /* Fonte maior */
        background: linear-gradient(45deg, #f0f0f0 0%, #dcdcdc 100%); /* Gradiente cinza claro */
        color: #333;
        border: 1px solid #ccc;
        border-radius: 10px; /* Cantos arredondados */
        transition: all 0.2s ease;
        padding: 0;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    #numeric-keypad button:hover {
        background: linear-gradient(45deg, #dcdcdc 0%, #f0f0f0 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    #numeric-keypad button:active {
        background-color: #c0c0c0;
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    #numeric-keypad button.key-backspace {
        background: linear-gradient(45deg, #e74c3c 0%, #c0392b 100%); /* Gradiente vermelho */
        color: white;
    }
    #numeric-keypad button.key-backspace:hover {
        background: linear-gradient(45deg, #c0392b 0%, #e74c3c 100%);
    }

    /* Settings Icon */
    .settings-icon {
        position: absolute;
        top: 15px; /* Ajustar conforme necess√°rio */
        right: 15px; /* Ajustar conforme necess√°rio */
        background: none;
        border: none;
        font-size: 2.5em; /* Tamanho do √≠cone */
        cursor: pointer;
        color: #555; /* Cor do √≠cone */
        transition: transform 0.2s ease;
        padding: 0; /* Remover padding padr√£o do bot√£o */
        box-shadow: none; /* Remover sombra padr√£o do bot√£o */
        z-index: 10; /* Garante que o √≠cone esteja acima dos outros elementos do container */
    }
    .settings-icon:hover {
        transform: rotate(30deg);
        color: #007bff;
    }

    /* Modal Overlay */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0, 0, 0, 0.7); /* Fundo semi-transparente */
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000; /* Acima de tudo */
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .modal-overlay.show {
        opacity: 1;
        visibility: visible;
    }

    /* Modal Content */
    .modal-content {
        background-color: #2c3e50; /* Azul escuro, como na imagem */
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
        width: 90%;
        max-width: 400px;
        position: relative;
        color: white;
        text-align: center;
        transform: scale(0.9);
        transition: transform 0.3s ease;
    }

    .modal-overlay.show .modal-content {
        transform: scale(1);
    }

    .modal-content h3 {
        color: #fff;
        font-size: 1.8em;
        margin-bottom: 25px;
    }

    /* Close Button */
    .close-button {
        position: absolute;
        top: 10px;
        right: 10px;
        background: none;
        border: none;
        color: #fff;
        font-size: 1.8em;
        cursor: pointer;
        padding: 5px;
        line-height: 1;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s ease;
    }
    .close-button:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }

    /* Setting Item */
    .setting-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        font-size: 1.2em;
    }
    .setting-item:last-of-type {
        border-bottom: none;
    }
    .setting-item span {
        flex-grow: 1;
        text-align: left;
        padding-left: 10px;
    }

    /* Toggle Switch */
    .toggle-switch {
        width: 60px;
        height: 30px;
        background-color: #ccc;
        border-radius: 15px;
        position: relative;
        cursor: pointer;
        transition: background-color 0.3s ease;
        flex-shrink: 0; /* N√£o permite que o switch encolha */
    }

    .toggle-switch.active {
        background-color: #4CAF50; /* Verde quando ativo */
    }

    .toggle-button {
        width: 26px;
        height: 26px;
        background-color: white;
        border-radius: 50%;
        position: absolute;
        top: 2px;
        left: 2px;
        transition: transform 0.3s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .toggle-switch.active .toggle-button {
        transform: translateX(30px); /* Move para a direita quando ativo */
    }

    /* Action Buttons in Settings */
    .settings-action-button {
        width: 100%;
        padding: 12px 20px;
        font-size: 1.2em;
        border-radius: 8px;
        margin-top: 15px; /* Espa√ßamento entre os bot√µes de a√ß√£o */
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        transition: all 0.3s ease;
    }

    .settings-action-button.green-button {
        background: linear-gradient(45deg, #4CAF50 0%, #218838 100%);
        color: white;
    }
    .settings-action-button.green-button:hover {
        background: linear-gradient(45deg, #218838 0%, #4CAF50 100%);
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }

    .settings-action-button.blue-button {
        background: linear-gradient(45deg, #007bff 0%, #0056b3 100%);
        color: white;
    }
    .settings-action-button.blue-button:hover {
        background: linear-gradient(45deg, #0056b3 0%, #007bff 100%);
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }

    /* New button for explaining concept */
    #explain-concept-button {
        margin-top: 20px;
        background: linear-gradient(45deg, #6c5ce7 0%, #483d8b 100%); /* Um roxo/azul escuro */
        color: white;
        padding: 15px 30px;
        font-size: 1.2em;
        border-radius: 10px;
        box-shadow: 0 5px 10px rgba(0,0,0,0.2);
    }
    #explain-concept-button:hover {
        background: linear-gradient(45deg, #483d8b 0%, #6c5ce7 100%);
        transform: translateY(-3px);
        box-shadow: 0 8px 15px rgba(0,0,0,0.3);
    }

    /* Wrapper para as duas listas de ranking */
    .ranking-lists-wrapper {
        display: flex;
        flex-direction: column; /* Padr√£o em coluna para telas pequenas */
        width: 100%; /* Ocupa a largura total do pai */
        gap: 20px; /* Espa√ßo entre as se√ß√µes de ranking */
        margin-bottom: 20px; /* Espa√ßo acima do bot√£o de voltar */
        align-items: center; /* Centraliza as se√ß√µes de ranking horizontalmente */
    }

    /* Ajustes para as se√ß√µes de ranking individuais dentro do wrapper */
    #rankings-container .ranking-section {
        width: 95%; /* Ocupa quase a largura total em telas pequenas */
        max-width: 400px; /* Limita a largura da se√ß√£o individual */
        margin: 0; /* Reseta margens de regras anteriores */
    }

    /* MEDIA QUERIES para layout responsivo */
    @media (min-width: 768px) { /* A partir de tablets e desktops */
        #embedded-rankings-area, .ranking-lists-wrapper { /* Aplica a ambos os wrappers de ranking */
            flex-direction: row; /* Coloca os rankings lado a lado */
            align-items: flex-start; /* Alinha os itens ao topo se tiverem alturas diferentes */
            justify-content: center; /* Centraliza o par de listas */
            flex-wrap: wrap; /* Permite que os itens quebrem se a tela for muito estreita */
        }
        #rankings-container .ranking-section, #embedded-rankings-area .ranking-section {
            flex: 1; /* Faz com que ocupem espa√ßo igual */
            max-width: 48%; /* Adiciona um pequeno espa√ßamento entre eles */
            margin: 0 10px; /* Adiciona margem horizontal */
            min-width: 300px; /* Garante que n√£o fiquem muito pequenos */
        }
        /* O bot√£o de voltar j√° est√° no fluxo de coluna do #rankings-container */
        /* e ser√° centralizado por align-items: center no #rankings-container */
    }

    @media (max-width: 600px) {
      body {
        padding: 10px; /* Reduz o padding do body em telas muito pequenas */
      }
      #game-container, .ranking-section, #mode-selection-container, #main-menu, #operation-selection-container, #competition-mode-selection-container {
        padding: 20px; /* Mant√©m padding interno dos containers */
        border-radius: 10px; /* Cantos um pouco menos arredondados em telas pequenas */
      }
      #splash-screen {
        font-size: 2.5em; /* Fonte menor na splash para telas pequenas */
      }
      #splash-screen .brain-icon {
        font-size: 4em;
      }
      #splash-screen .splash-text {
        font-size: 1.2em;
      }

      .main-title-box {
        padding: 15px 20px;
        max-width: 250px;
      }
      .main-title-box .brain-icon-title {
        font-size: 3em;
      }
      .main-title-box .title-text {
        font-size: 1.5em;
      }

      #main-menu .math-symbols {
        font-size: 4em; /* S√≠mbolos menores em telas pequenas */
        letter-spacing: 8px;
        gap: 10px;
      }
      #main-menu .menu-buttons {
        width: 90%;
        gap: 15px;
      }
      #main-menu .menu-buttons button {
        font-size: 1.5em; /* Bot√µes de menu menores */
        padding: 15px 25px;
      }
      #question {
        font-size: 1.8em; /* Fonte menor para perguntas e t√≠tulos */
      }
      #answer-input, #player-name-input {
        font-size: 1.2em; /* Inputs menores */
        padding: 12px;
      }
      button {
        font-size: 1em; /* Bot√µes menores */
        padding: 10px 20px;
      }
      #numeric-keypad {
        max-width: 280px; /* Ajuste para telas menores */
        gap: 10px; /* Espa√ßamento menor no teclado */
        padding: 15px;
      }
      #numeric-keypad button {
        height: 60px; /* Altura dos bot√µes menor */
        font-size: 1.6em; /* Fonte menor */
      }
      .settings-icon {
            font-size: 2em;
            top: 10px;
            right: 10px;
        }
        .modal-content {
            padding: 20px;
            max-width: 95%;
        }
        .modal-content h3 {
            font-size: 1.5em;
            margin-bottom: 20px;
        }
        .setting-item {
            font-size: 1em;
            padding: 10px 0;
        }
        .toggle-switch {
            width: 50px;
            height: 25px;
            border-radius: 12.5px;
        }
        .toggle-button {
            width: 21px;
            height: 21px;
            top: 2px;
            left: 2px;
        }
        .toggle-switch.active .toggle-button {
            transform: translateX(25px);
        }
        .settings-action-button {
            font-size: 1em;
            padding: 10px 15px;
        }
    }

  </style>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

</head>
<body>
  <!-- Splash Screen -->
  <div id="splash-screen">
    <span class="brain-icon">üß†</span>
    <span class="splash-text">Desafio dos<br>60 Segundos</span>
  </div>

  <!-- Menu Principal -->
  <div id="main-menu">
    <!-- Novo T√≠tulo do Jogo -->
    <div class="main-title-box">
        <span class="brain-icon-title">üß†</span>
        <span class="title-text">Matem√°tica em</span>
        <span class="title-text">60 Segundos</span>
    </div>

    <div class="math-symbols">
        <span>+</span>
        <span>-</span>
        <span>√ó</span>
        <span>√∑</span>
    </div>
    <div class="menu-buttons">
      <button id="practice-button">Praticar</button>
      <button id="competition-button">Competi√ß√£o</button> <!-- Bot√£o renomeado -->
    </div>
  </div>

  <!-- Conte√∫do da Sele√ß√£o de Opera√ß√£o (NOVA TELA) -->
  <div id="operation-selection-container">
    <h3>Escolha a Opera√ß√£o para Praticar:</h3>
    <div class="operation-buttons">
        <button data-op="+">Adi√ß√£o (+)</button>
        <button data-op="-">Subtra√ß√£o (-)</button>
        <button data-op="*">Multiplica√ß√£o (√ó)</button>
        <button data-op="√∑">Divis√£o (√∑)</button>
        <button data-op="all">Todos Juntos</button>
    </div>
    <button id="back-to-main-from-operation" class="back-button">Voltar ao Menu Principal</button>
  </div>

  <!-- Conte√∫do da Sele√ß√£o de Modo (Para o modo Praticar) -->
  <div id="mode-selection-container">
    <h3>Escolha o Modo de Jogo:</h3>
    <button id="mode-kids-button" class="mode-button" data-mode="practice_kids">Modo Kids</button>
    <button id="mode-adults-button" class="mode-button" data-mode="practice_adults">Modo Adulto</button>
    <button id="back-to-operation-selection" class="back-button">Voltar para Sele√ß√£o de Opera√ß√£o</button> <!-- Bot√£o de voltar atualizado -->
  </div>

  <!-- Conte√∫do da Sele√ß√£o de Modo de Competi√ß√£o (NOVA TELA) -->
  <div id="competition-mode-selection-container">
    <h3>Modo Competi√ß√£o:</h3>
    <div class="competition-buttons">
        <button data-mode="competition_kids">Kids</button>
        <button data-mode="competition_adults">Adulto</button>
    </div>
    <!-- Rankings vis√≠veis diretamente aqui -->
    <div id="embedded-rankings-area">
        <div id="ranking-kids-area-comp" class="ranking-section">
            <h2>üèÜ Ranking Kids (Top 10)</h2>
            <ol id="ranking-kids-list-comp" class="ranking-list">
            </ol>
        </div>

        <div id="ranking-adults-area-comp" class="ranking-section">
            <h2>üèÜ Ranking Adulto (Top 10)</h2>
            <ol id="ranking-adults-list-comp" class="ranking-list">
            </ol>
        </div>
    </div>
    <button id="back-to-main-from-competition-mode" class="back-button">Voltar ao Menu Principal</button>
  </div>

  <!-- Conte√∫do do Jogo -->
  <div id="game-container">
    <!-- √çcone de Configura√ß√µes -->
    <button id="settings-icon" class="settings-icon">‚öôÔ∏è</button>

    <div id="status">
      <p id="timer">Tempo: <span id="timer-value">60s</span></p>
      <div id="time-bar-container">
          <div id="time-bar"></div>
      </div>
      <p id="score">Pontos: <span id="score-value">0</span></p>
    </div>

    <div id="question-area">
      <p id="difficulty-level"></p> 
      <p id="question">Selecione um modo e digite seu nome para come√ßar!</p>
      <input type="text" id="player-name-input" placeholder="Seu nome" maxlength="20" pattern="[A-Za-z√Ä-√∫\s]+" title="Apenas letras e espa√ßos s√£o permitidos.">
      <input type="text" id="answer-input" placeholder="Digite a resposta" readonly>
      <p id="message"></p> <!-- Mensagem de feedback (agora sempre vazia e invis√≠vel) -->
    </div>

    <button id="explain-concept-button" style="display: none;">‚ú® Explicar Conceito ‚ú®</button> <!-- Novo bot√£o -->
    <button id="start-game-button" style="display: none;">Come√ßar Jogo</button>
    <button id="play-again" style="display: none;">Jogar Novamente</button>
  </div>

  <!-- Teclado Num√©rico -->
  <div id="numeric-keypad">
    <button data-value="1">1</button>
    <button data-value="2">2</button>
    <button data-value="3">3</button>
    <button data-value="4">4</button>
    <button data-value="5">5</button>
    <button data-value="6">6</button>
    <button data-value="7">7</button>
    <button data-value="8">8</button>
    <button data-value="9">9</button>
    <button data-value="clear" class="key-backspace">APAGAR</button>
    <button data-value="0">0</button>
  </div>

  <!-- Container de Rankings (Tela de Ranking Completo) -->
  <div id="rankings-container">
    <div class="ranking-lists-wrapper"> <!-- NOVO WRAPPER -->
        <div id="ranking-kids-area" class="ranking-section">
          <h2>üèÜ Ranking Kids (Top 10)</h2>
          <ol id="ranking-kids-list" class="ranking-list">
          </ol>
        </div>

        <div id="ranking-adults-area" class="ranking-section">
          <h2>üèÜ Ranking Adulto (Top 10)</h2>
          <ol id="ranking-adults-list" class="ranking-list">
          </ol>
        </div>
    </div> <!-- FIM DO NOVO WRAPPER -->
    <button id="back-to-main-from-ranking" class="back-button">Voltar ao Menu Principal</button>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="modal-overlay">
    <div class="modal-content">
      <button class="close-button" id="close-settings-modal">X</button>
      <h3>Configura√ß√µes</h3>
      <div class="setting-item">
        <span>üîä Som</span>
        <div class="toggle-switch" id="toggle-sound">
          <div class="toggle-button"></div>
        </div>
      </div>
      <div class="setting-item">
        <span>üéµ M√∫sica de Fundo</span>
        <div class="toggle-switch" id="toggle-bgm">
          <div class="toggle-button"></div>
        </div>
      </div>
      <div class="setting-item">
        <span>üì≥ Vibra√ß√£o</span>
        <div class="toggle-switch" id="toggle-vibration">
          <div class="toggle-button"></div>
        </div>
      </div>
      <div class="setting-item button-item">
        <button id="settings-home-button" class="settings-action-button green-button">üè† In√≠cio</button>
      </div>
      <div class="setting-item button-item">
        <button id="settings-replay-button" class="settings-action-button green-button">üîÑ Jogar Novamente</button>
      </div>
      <div class="setting-item button-item">
        <button id="settings-more-button" class="settings-action-button blue-button">‚öôÔ∏è Mais Op√ß√µes</button>
      </div>
    </div>
  </div>

  <!-- Explanation Modal -->
  <div id="explanation-modal" class="modal-overlay">
    <div class="modal-content">
      <button class="close-button" id="close-explanation-modal">X</button>
      <h3>‚ú® Explica√ß√£o do Conceito ‚ú®</h3>
      <p id="explanation-text">Carregando explica√ß√£o...</p>
      <button class="settings-action-button blue-button" id="explanation-ok-button">Entendi!</button>
    </div>
  </div>

  <!-- Game Over Modal (for Competition Mode) -->
  <div id="game-over-modal" class="modal-overlay">
    <div class="modal-content">
      <h3>Fim de Jogo!</h3>
      <p id="final-score-text"></p>
      <p id="final-rank-text"></p>
      <button id="view-full-ranking-button" class="settings-action-button blue-button">Ver Ranking Completo</button>
      <button id="game-over-main-menu-button" class="settings-action-button green-button">Voltar ao Menu Principal</button>
    </div>
  </div>

  <!-- Blocos de An√∫ncio (fora dos containers de tela para evitar interfer√™ncia de layout) -->
  <div style="width: 100%; max-width: 728px; margin: 20px auto; text-align: center;">
    <ins class="adsbygoogle"
         style="display:block; width:100%; height:auto; min-height:90px;"
         data-ad-client="ca-pub-9968425306160320"
         data-ad-slot="9401721950"
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
  </div>

  <div style="width: 100%; max-width: 728px; margin: 20px auto; text-align: center;">
    <ins class="adsbygoogle"
         style="display:block; width:100%; height:auto; min-height:90px;"
         data-ad-client="ca-pub-9968425306160320"
         data-ad-slot="SEU_SLOT_ID_2"
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
  </div>

  <div style="width: 100%; max-width: 728px; margin: 20px auto 0 auto; text-align: center;">
    <ins class="adsbygoogle"
         style="display:block; width:100%; height:auto; min-height:90px;"
         data-ad-client="ca-pub-9968425306160320"
         data-ad-slot="SEU_SLOT_ID_3"
         data-ad-format="auto"
         data-full-width-responsive="true"></ins>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
  </div>

  <script>
    // Configura√ß√£o do Firebase para o "Desafio dos 60 Segundos"
    // Use as credenciais do projeto "desafio-dos-60-segundos"
    const firebaseConfig = {
      apiKey: "AIzaSyA4PWRt-22S8HGc6GS1m-4Wa9hYsh5Zbo",
      authDomain: "desafio-dos-60-segundos.firebaseapp.com",
      projectId: "desafio-dos-60-segundos",
      storageBucket: "desafio-dos-60-segundos.firebaseapp.com",
      messagingSenderId: "1054471364887",
      appId: "1:1054471364887:web:332b4f28814e9f5d0cd752",
      measurementId: "G-N4PWJ72YCJ"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = app.firestore(); 

    const splashScreen = document.getElementById('splash-screen');
    const mainMenu = document.getElementById('main-menu');
    const operationSelectionContainer = document.getElementById('operation-selection-container'); 
    const modeSelectionContainer = document.getElementById('mode-selection-container'); 
    const competitionModeSelectionContainer = document.getElementById('competition-mode-selection-container'); 
    const gameContainer = document.getElementById('game-container');
    const rankingsContainer = document.getElementById('rankings-container');

    const questionElement = document.getElementById('question');
    const answerInput = document.getElementById('answer-input');
    const playerNameInput = document.getElementById('player-name-input');
    const messageElement = document.getElementById('message'); // Agora ser√° sempre vazio e invis√≠vel
    const timerValueElement = document.getElementById('timer-value');
    const scoreValueElement = document.getElementById('score-value');
    const startGameButton = document.getElementById('start-game-button');
    const playAgainButton = document.getElementById('play-again');
    const timeBar = document.getElementById('time-bar');
    const difficultyLevelElement = document.getElementById('difficulty-level'); 

    // Elementos de Modo de Jogo
    const modeKidsButton = document.getElementById('mode-kids-button');
    const modeAdultsButton = document.getElementById('mode-adults-button');
    let currentGameMode = null; // 'practice_kids', 'practice_adults', 'competition_kids', 'competition_adults'

    // Vari√°veis de controlo de dificuldade
    let correctAnswersCount = 0; // Para controlo da dificuldade din√¢mica no modo adulto

    // Elementos de Ranking
    const rankingKidsList = document.getElementById('ranking-kids-list'); // Main ranking screen
    const rankingAdultsList = document.getElementById('ranking-adults-list'); // Main ranking screen
    const rankingKidsListComp = document.getElementById('ranking-kids-list-comp'); // Embedded in competition screen
    const rankingAdultsListComp = document.getElementById('ranking-adults-list-comp'); // Embedded in competition screen


    // Elemento do Teclado Num√©rico
    const numericKeypad = document.getElementById('numeric-keypad');

    // Bot√µes do novo menu principal
    const practiceButton = document.getElementById('practice-button');
    const competitionButton = document.getElementById('competition-button'); 
    const backToMainFromOperationButton = document.getElementById('back-to-main-from-operation'); 
    const backToOperationSelectionButton = document.getElementById('back-to-operation-selection'); 
    const backToMainFromCompetitionModeButton = document.getElementById('back-to-main-from-competition-mode'); 
    const backToMainFromRankingButton = document.getElementById('back-to-main-from-ranking');

    // Elementos do Modal de Configura√ß√µes
    const settingsIcon = document.getElementById('settings-icon');
    const settingsModal = document.getElementById('settings-modal');
    const closeSettingsModalButton = document.getElementById('close-settings-modal');

    const toggleSound = document.getElementById('toggle-sound');
    const toggleBGM = document.getElementById('toggle-bgm');
    const toggleVibration = document.getElementById('toggle-vibration');

    const settingsHomeButton = document.getElementById('settings-home-button');
    const settingsReplayButton = document.getElementById('settings-replay-button');
    const settingsMoreButton = document.getElementById('settings-more-button');

    // Elementos do Modal de Explica√ß√£o de Conceito
    const explainConceptButton = document.getElementById('explain-concept-button');
    const explanationModal = document.getElementById('explanation-modal');
    const closeExplanationModalButton = document.getElementById('close-explanation-modal');
    const explanationText = document.getElementById('explanation-text');
    const explanationOkButton = document.getElementById('explanation-ok-button');

    // New elements for Game Over Modal
    const gameOverModal = document.getElementById('game-over-modal');
    const finalScoreText = document.getElementById('final-score-text');
    const finalRankText = document.getElementById('final-rank-text');
    const viewFullRankingButton = document.getElementById('view-full-ranking-button');
    const gameOverMainMenuButton = document.getElementById('game-over-main-menu-button');


    // Estados das configura√ß√µes (iniciam como ativos)
    let isSoundOn = true;
    let isBGMOn = true;
    let isVibrationOn = true;

    let currentQuestion;
    let score = 0;
    let timeLeft = 60;
    let timerInterval;
    let gameActive = false;
    let currentPlayerName = '';
    let questionStartTime; 
    let selectedOperationType = 'all'; // Default para 'all' no modo pr√°tica, mas pode ser alterado

    // Os ficheiros de √°udio (correct.mp3, incorrect.mp3) devem estar na mesma pasta ou num caminho acess√≠vel
    const correctSound = new Audio('correct.mp3'); 
    const incorrectSound = new Audio('incorrect.mp3');

    // Nomes dos n√≠veis de dificuldade (agora usados internamente para exibi√ß√£o)
    const difficultyNames = {
        1: "Iniciante", // 0-4 respostas corretas (Adultos)
        2: "Amador",   // 5-9 respostas corretas (Adultos)
        3: "Desafiador", // 10-15 respostas corretas (Adultos)
        4: "Mestre",    // 16+ respostas corretas (Adultos)
        "kids_easy": "F√°cil" // N√≠vel fixo para Kids
    };

    // --- Fun√ß√µes de Navega√ß√£o de Tela ---
    function hideAllScreens() {
        // Esconde todos os containers de conte√∫do principal
        splashScreen.classList.remove('active', 'fade-out');
        splashScreen.style.display = 'none'; // Garante que est√° oculto

        mainMenu.classList.remove('active');
        mainMenu.style.display = 'none';

        operationSelectionContainer.classList.remove('active'); 
        operationSelectionContainer.style.display = 'none';

        modeSelectionContainer.classList.remove('active');
        modeSelectionContainer.style.display = 'none';

        competitionModeSelectionContainer.classList.remove('active'); 
        competitionModeSelectionContainer.style.display = 'none';

        gameContainer.classList.remove('active');
        gameContainer.style.display = 'none';

        rankingsContainer.classList.remove('active');
        rankingsContainer.style.display = 'none';

        numericKeypad.style.display = 'none'; // Sempre esconde o teclado
        
        // Esconde os modais tamb√©m
        hideSettingsModal();
        hideExplanationModal();
        hideGameOverModal(); // Esconde o modal de Game Over
    }

    function showSplashScreen() {
        hideAllScreens(); // Esconde todas as outras telas primeiro
        splashScreen.style.display = 'flex'; // Mostra a splash screen
        splashScreen.classList.add('active'); // Ativa para transi√ß√£o de opacidade
        splashScreen.classList.remove('fade-out'); // Garante que n√£o est√° a desvanecer de uma execu√ß√£o anterior

        setTimeout(() => {
            splashScreen.classList.add('fade-out'); // Inicia anima√ß√£o de fade-out
            setTimeout(() => {
                splashScreen.style.display = 'none'; // Esconde ap√≥s fade-out
                showMainMenu();
            }, 500); // Dura√ß√£o da anima√ß√£o de fade-out
        }, 2000); // Dura√ß√£o que a splash screen √© vis√≠vel (2 segundos)
    }

    function showMainMenu() {
        hideAllScreens();
        mainMenu.style.display = 'flex'; // Mostra como flex
        mainMenu.classList.add('active'); // Ativa para anima√ß√£o
        
        // Resetar estado de bot√µes de modo
        modeKidsButton.classList.remove('active');
        modeAdultsButton.classList.remove('active');
        // Resetar texto da pergunta e dificuldade
        questionElement.textContent = 'Selecione um modo e digite seu nome para come√ßar!';
        difficultyLevelElement.textContent = '';
        // Esconder inputs e bot√µes de jogo
        playerNameInput.style.display = 'none';
        answerInput.style.display = 'none';
        startGameButton.style.display = 'none';
        playAgainButton.style.display = 'none';
        explainConceptButton.style.display = 'none'; // Esconde o bot√£o de explica√ß√£o
    }

    function showOperationSelection() { 
        hideAllScreens();
        operationSelectionContainer.style.display = 'flex';
        operationSelectionContainer.classList.add('active');
        // Desativa a sele√ß√£o de opera√ß√£o inicial
        selectedOperationType = null; // Reseta a opera√ß√£o selecionada
        document.querySelectorAll('#operation-selection-container .operation-buttons button').forEach(btn => {
            btn.classList.remove('active');
        });
    }

    function selectOperation(operation) { 
        selectedOperationType = operation;
        // Atualiza o estado visual dos bot√µes de opera√ß√£o
        document.querySelectorAll('#operation-selection-container .operation-buttons button').forEach(btn => {
            if (btn.dataset.op === operation) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
        // Ap√≥s selecionar a opera√ß√£o, avan√ßa para a sele√ß√£o de modo (para pr√°tica)
        showModeSelectionForPractice();
    }


    function showModeSelectionForPractice() { // Fun√ß√£o espec√≠fica para sele√ß√£o de modo no modo "Praticar"
        hideAllScreens();
        modeSelectionContainer.style.display = 'flex'; // Mostra como flex
        modeSelectionContainer.classList.add('active'); // Ativa para anima√ß√£o
        // Define o currentGameMode como "practice" para diferenciar na gera√ß√£o de perguntas
        // O modo espec√≠fico (kids/adults) ser√° definido ao clicar nos bot√µes de modo
        currentGameMode = 'practice'; 
        modeKidsButton.classList.remove('active');
        modeAdultsButton.classList.remove('active');
    }

    function showCompetitionModeSelection() { // Nova fun√ß√£o para sele√ß√£o de modo de competi√ß√£o
        hideAllScreens();
        competitionModeSelectionContainer.style.display = 'flex';
        competitionModeSelectionContainer.classList.add('active');
        // Resetar o modo de jogo ao entrar nesta tela
        currentGameMode = null;
        // Exibir rankings embutidos
        displayRanking('kids', rankingKidsListComp);
        displayRanking('adults', rankingAdultsListComp);
    }

    function showGameScreen() {
        hideAllScreens(); // Esconde todas as telas
        gameContainer.style.display = 'flex'; // Mostra a tela do jogo
        gameContainer.classList.add('active'); // Ativa para anima√ß√£o
        // numericKeypad.style.display = 'grid'; // O teclado s√≥ aparece quando o jogo *come√ßa* de fato
    }

    function showRankingsScreen() {
        hideAllScreens();
        rankingsContainer.style.display = 'flex'; // Mostra como flex
        rankingsContainer.classList.add('active'); // Ativa para anima√ß√£o
        displayRanking('kids', rankingKidsList); // Atualiza rankings ao mostrar
        displayRanking('adults', rankingAdultsList);
    }

    // Fun√ß√µes do Modal de Configura√ß√µes
    function showSettingsModal() {
        settingsModal.classList.add('show');
        // Garante que o estado atual dos toggles √© refletido ao abrir o modal
        if (isSoundOn) toggleSound.classList.add('active'); else toggleSound.classList.remove('active');
        if (isBGMOn) toggleBGM.classList.add('active'); else toggleBGM.classList.remove('active');
        if (isVibrationOn) toggleVibration.classList.add('active'); else toggleVibration.classList.remove('active');
    }

    function hideSettingsModal() {
        settingsModal.classList.remove('show');
    }

    // Fun√ß√µes do Modal de Explica√ß√£o
    async function showExplanationModal() {
        explanationModal.classList.add('show');
        explanationText.textContent = 'Carregando explica√ß√£o...'; // Mensagem de carregamento

        // Chamar a API Gemini para obter a explica√ß√£o
        const prompt = `Explique o conceito matem√°tico por tr√°s da opera√ß√£o "${currentQuestion.question}" de forma simples e did√°tica, como se estivesse a ensinar a uma crian√ßa. Foco no conceito e n√£o apenas no c√°lculo. Seja conciso.`;
        
        try {
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = ""; // If you want to use models other than gemini-2.0-flash or imagen-3.0-generate-002, provide an API key here. Otherwise, leave this as-is.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();

            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                const text = result.candidates[0].content.parts[0].text;
                explanationText.textContent = text;
            } else {
                explanationText.textContent = 'N√£o foi poss√≠vel gerar a explica√ß√£o. Tente novamente.';
                console.error('Estrutura de resposta inesperada da API Gemini:', result);
            }
        } catch (error) {
            explanationText.textContent = 'Erro ao conectar com a IA. Verifique sua conex√£o ou tente mais tarde.';
            console.error('Erro ao chamar a API Gemini:', error);
        }
    }

    function hideExplanationModal() {
        explanationModal.classList.remove('show');
    }

    // Fun√ß√µes do Modal de Fim de Jogo
    function showGameOverModal(score, rank, mode) {
        finalScoreText.textContent = `Voc√™ fez ${score} pontos.`;
        finalRankText.textContent = `Voc√™ ficou em ${rank}¬∫ lugar no ranking de ${mode.includes('kids') ? 'Kids' : 'Adulto'}!`;
        gameOverModal.classList.add('show');
    }

    function hideGameOverModal() {
        gameOverModal.classList.remove('show');
    }


    // Fun√ß√£o para lidar com os toggles (som, BGM, vibra√ß√£o)
    function handleToggle(element, stateVar) {
        if (element.classList.contains('active')) {
            element.classList.remove('active');
            stateVar = false;
            // console.log(`${element.id} desligado.`); // Para debug
        } else {
            element.classList.add('active');
            stateVar = true;
            // console.log(`${element.id} ligado.`); // Para debug
        }
        return stateVar; // Retorna o estado atualizado
    }

    // --- Fun√ß√µes do Jogo ---

    function selectGameModeAndStart(mode) { 
        currentGameMode = mode;
        correctAnswersCount = 0; // Reseta o contador de respostas corretas ao mudar o modo
        
        if (mode.startsWith('practice_')) {
            modeKidsButton.classList.remove('active');
            modeAdultsButton.classList.remove('active');
            if (mode === 'practice_kids') {
                modeKidsButton.classList.add('active');
            } else if (mode === 'practice_adults') {
                modeAdultsButton.classList.add('active');
            }
        }

        showGameScreen(); // Mostra a tela do jogo (para entrada de nome e in√≠cio)

        playerNameInput.style.display = 'inline-block';
        startGameButton.style.display = 'inline-block';
        answerInput.style.display = 'none'; 
        playAgainButton.style.display = 'none'; 
        explainConceptButton.style.display = 'none'; 

        playerNameInput.value = ''; 
        playerNameInput.focus(); 
        questionElement.textContent = 'Digite seu nome e clique em "Come√ßar Jogo"!';
        difficultyLevelElement.textContent = ''; 
        numericKeypad.style.display = 'none'; 
    }

    function saveRanking(player, score, mode, difficultyLevelPlayed) {
        // Extrai 'kids' ou 'adults' do modo completo para salvar no ranking
        const baseMode = mode.includes('kids') ? 'kids' : 'adults';
        const collectionName = `ranking_${baseMode}`;
        db.collection(collectionName).add({
            player: player,
            score: score,
            difficulty: difficultyLevelPlayed, // Salva o nome do n√≠vel (string)
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then((docRef) => {
            console.log("Documento escrito com ID: ", docRef.id);
        })
        .catch((error) => {
            console.error("Erro ao adicionar documento: ", error);
            alert("Erro ao salvar pontua√ß√£o. Por favor, tente novamente mais tarde.");
        });
    }

    async function displayRanking(mode, targetListElement) {
        const rankingListElement = targetListElement; // Agora recebe o elemento diretamente
        const collectionName = `ranking_${mode}`;

        rankingListElement.innerHTML = '<li>Carregando ranking...</li>';

        try {
            const snapshot = await db.collection(collectionName)
                                                .orderBy("score", "desc")
                                                .limit(10) // Limitado a 10 resultados
                                                .get();
            rankingListElement.innerHTML = '';
            if (snapshot.empty) {
                rankingListElement.innerHTML = '<li>Nenhum recorde ainda. Seja o primeiro!</li>';
                return;
            }

            const rankings = [];
            snapshot.forEach((doc) => {
                rankings.push(doc.data());
            });

            rankings.forEach((data, index) => {
                const li = document.createElement('li');
                const rankingPosition = index + 1;

                const positionSpan = `<span class="ranking-position">${rankingPosition}¬∫</span>`;
                const nameSpan = `<span class="ranking-name">${data.player}</span>`;
                const levelSpan = data.difficulty ? `<span class="ranking-level">(${data.difficulty})</span>` : ''; 
                const scoreSpan = `<span class="ranking-score">${data.score}</span>`;
                
                li.innerHTML = `${positionSpan} ${nameSpan} ${levelSpan} ${scoreSpan}`; 
                
                if (rankingPosition <= 3) {
                    li.classList.add('ranking-item-top'); 
                }
                if (rankings.length >= 4) {
                    const startIndexForBottom = Math.max(0, rankings.length - 3); 
                    if (index >= startIndexForBottom) {
                        li.classList.add('ranking-item-bottom');
                    }
                }

                rankingListElement.appendChild(li);
            });

        } catch (error) {
            console.error(`Erro ao carregar ranking ${mode}: `, error);
            rankingListElement.innerHTML = '<li>Erro ao carregar ranking.</li>';
        }
    }

    function random() {
        return Math.random();
    }
    function randomInt(min, max) {
        return Math.floor(random() * (max - min + 1)) + min;
    }

    function generateQuestion() {
        let num1, num2;
        let operatorsToUse; 
        let operator;
        let correctAnswer;
        let currentLevelName; 

        explainConceptButton.style.display = 'none'; 

        if (currentGameMode.startsWith('practice_')) {
            if (selectedOperationType === 'all') {
                operatorsToUse = ['+', '-', '*', '√∑'];
            } else {
                operatorsToUse = [selectedOperationType];
            }
            num1 = randomInt(1, 15);
            num2 = randomInt(1, 15);
            currentLevelName = difficultyNames["kids_easy"]; 
        } else { // Modos de Competi√ß√£o
            if (currentGameMode === 'competition_kids') {
                operatorsToUse = ['+', '-'];
                num1 = randomInt(1, 10);
                num2 = randomInt(1, 10);
                currentLevelName = difficultyNames["kids_easy"];
            } else { // 'competition_adults'
                operatorsToUse = ['+', '-', '*', '√∑']; 
                if (correctAnswersCount < 5) {
                    operatorsToUse = ['+']; 
                    num1 = randomInt(1, 20);
                    num2 = randomInt(1, 20);
                    currentLevelName = difficultyNames[1];
                } else if (correctAnswersCount < 10) {
                    operatorsToUse = ['+', '-'];
                    num1 = randomInt(1, 30);
                    num2 = randomInt(1, 30);
                    currentLevelName = difficultyNames[2];
                } else if (correctAnswersCount < 16) {
                    operatorsToUse = ['+', '-', '*'];
                    num1 = randomInt(1, 50);
                    num2 = randomInt(1, 50);
                    currentLevelName = difficultyNames[3];
                } else {
                    operatorsToUse = ['+', '-', '*', '√∑'];
                    num1 = randomInt(1, 70);
                    num2 = randomInt(1, 70);
                    currentLevelName = difficultyNames[4];
                }
            }
        }
        
        operator = operatorsToUse[Math.floor(random() * operatorsToUse.length)];

        if (operator === '-') {
            if (num1 < num2) { 
                [num1, num2] = [num2, num1];
            }
        } else if (operator === '√∑') {
            // Garante que a divis√£o sempre resulte em um n√∫mero inteiro
            num2 = randomInt(1, 10); // Divisor entre 1 e 10
            num1 = randomInt(1, 10) * num2; // num1 ser√° um m√∫ltiplo de num2
        } else if (operator === '*') {
            if (currentGameMode.startsWith('practice_') || currentGameMode === 'competition_kids') {
                num1 = randomInt(1, 9);
                num2 = randomInt(1, 9);
            } else { 
                num1 = randomInt(1, 12);
                num2 = randomInt(1, 12);
            }
        }

        let questionString;
        let finalAnswer;

        if (operator === '+') {
            questionString = `${num1} + ${num2}`;
            finalAnswer = num1 + num2;
        } else if (operator === '-') {
            questionString = `${num1} - ${num2}`;
            finalAnswer = num1 - num2;
        } else if (operator === '*') {
            questionString = `${num1} √ó ${num2}`; 
            finalAnswer = num1 * num2;
        } else { 
            questionString = `${num1} √∑ ${num2}`;
            finalAnswer = num1 / num2;
        }

        // A resposta agora ser√° sempre um n√∫mero inteiro devido √† l√≥gica de divis√£o
        correctAnswer = finalAnswer; 

        currentQuestion = { question: questionString, answer: correctAnswer };
        questionElement.textContent = currentQuestion.question;
        
        let displayModeText = '';
        if (currentGameMode.startsWith('practice_')) {
            displayModeText = 'Praticar';
        } else if (currentGameMode.startsWith('competition_')) {
            displayModeText = 'Competi√ß√£o';
        }
        difficultyLevelElement.textContent = `N√≠vel: ${currentLevelName} (${displayModeText})`; 
        
        answerInput.value = '';
        // Garante que as classes de feedback visual est√£o limpas ao gerar nova pergunta
        answerInput.classList.remove('correct', 'incorrect', 'correct-input-anim', 'incorrect-input-anim');
        questionElement.classList.remove('correct-animation', 'incorrect-animation');
        messageElement.textContent = ''; // Limpa a mensagem
        messageElement.classList.remove('show', 'correct-text', 'incorrect-text', 'speed-bonus-text'); 
        
        questionStartTime = Date.now(); 
    }

    function startGame() {
      if (!currentGameMode) { 
          alert("Por favor, selecione um modo de jogo antes de come√ßar.");
          return;
      }
      if (currentGameMode.startsWith('practice_') && selectedOperationType === null) {
          alert("Por favor, selecione uma opera√ß√£o para praticar.");
          return;
      }

      currentPlayerName = playerNameInput.value.trim();
      
      if (!playerNameInput.checkValidity()) {
        alert(playerNameInput.title);
        playerNameInput.focus();
        return;
      }
      if (currentPlayerName === '') {
        alert("Por favor, digite seu nome para come√ßar o jogo!");
        playerNameInput.focus();
        return;
      }

      score = 0;
      timeLeft = 60;
      gameActive = true;
      correctAnswersCount = 0; 
      scoreValueElement.textContent = score;
      timerValueElement.textContent = timeLeft + 's';
      
      playerNameInput.style.display = 'none';
      startGameButton.style.display = 'none'; 
      answerInput.style.display = 'inline-block'; 
      answerInput.disabled = false;

      numericKeypad.style.display = 'grid'; 
      
      questionElement.textContent = 'Preparar...';
      difficultyLevelElement.textContent = ''; 
      
      playAgainButton.style.display = 'none';
      explainConceptButton.style.display = 'none'; 
      
      timeBar.style.width = '100%';
      timeBar.style.backgroundColor = '#4CAF50';
      timeBar.classList.remove('time-bar-shaking');

      setTimeout(() => {
        generateQuestion();
        timerInterval = setInterval(() => {
          timeLeft--;
          timerValueElement.textContent = timeLeft + 's';
          
          const percentage = (timeLeft / 60) * 100;
          timeBar.style.width = percentage + '%';

          if (percentage > 50) {
              timeBar.style.backgroundColor = '#4CAF50';
          } else if (percentage > 20) {
              timeBar.style.backgroundColor = '#FFC107';
              if (timeLeft <= 10 && !timeBar.classList.contains('time-bar-shaking')) {
                  timeBar.classList.add('time-bar-shaking');
              }
          } else {
              timeBar.style.backgroundColor = '#DC3545';
              if (timeLeft <= 10 && !timeBar.classList.contains('time-bar-shaking')) {
                  timeBar.classList.add('time-bar-shaking');
                  void timeBar.offsetWidth; 
              }
          }

          if (timeLeft <= 0) {
            endGame();
          }
        }, 1000);
      }, 1000);
    }

    function endGame() {
      clearInterval(timerInterval);
      gameActive = false;
      answerInput.disabled = true;
      playAgainButton.style.display = 'inline-block';
      // Mensagem final de pontua√ß√£o permanece
      messageElement.textContent = `Tempo esgotado! Voc√™ fez ${score} pontos.`;
      messageElement.classList.add('show'); // Pode mostrar apenas a mensagem final
      messageElement.classList.remove('correct-text', 'incorrect-text', 'speed-bonus-text'); 
      
      answerInput.classList.remove('correct', 'incorrect', 'correct-input-anim', 'incorrect-input-anim');
      questionElement.classList.remove('correct-animation', 'incorrect-animation');
      timeBar.classList.remove('time-bar-shaking');
      explainConceptButton.style.display = 'none'; 

      // Salva o ranking SOMENTE nos modos de competi√ß√£o
      if (currentGameMode.startsWith('competition_')) {
          let finalDifficultyLevelName;
          const baseMode = currentGameMode.includes('kids') ? 'kids' : 'adults';

          if (currentGameMode === 'competition_kids') {
              finalDifficultyLevelName = difficultyNames["kids_easy"];
          } else { // competition_adults
              if (correctAnswersCount >= 16) {
                  finalDifficultyLevelName = difficultyNames[4]; // Mestre
              } else if (correctAnswersCount >= 10) {
                  finalDifficultyLevelName = difficultyNames[3]; // Desafiador
              } else if (correctAnswersCount >= 5) {
                  finalDifficultyLevelName = difficultyNames[2]; // Amador
              } else {
                  finalDifficultyLevelName = difficultyNames[1]; // Iniciante
              }
          }
          saveRanking(currentPlayerName, score, currentGameMode, finalDifficultyLevelName);

          // Calculate rank and show game over modal
          calculateAndShowRank(score, baseMode);

      } else { // Practice mode ends
          playerNameInput.value = '';
          playerNameInput.style.display = 'inline-block';
          answerInput.style.display = 'none';
          showMainMenu(); // Go back to main menu for practice mode
          currentGameMode = null;
          selectedOperationType = 'all';
          questionElement.textContent = 'Selecione um modo e digite seu nome para come√ßar!';
          difficultyLevelElement.textContent = '';
          numericKeypad.style.display = 'none';
      }
    }

    // New function to calculate rank and show modal
    async function calculateAndShowRank(playerScore, mode) {
        const collectionName = `ranking_${mode}`;
        try {
            const snapshot = await db.collection(collectionName)
                                        .orderBy("score", "desc")
                                        .get();
            
            const allEntries = [];
            snapshot.forEach(doc => allEntries.push(doc.data()));

            let playerRank = 1;
            let currentRank = 1;
            let lastScore = -1; // Initialize with a score lower than any possible score

            // Sort entries by score in descending order to ensure correct ranking logic
            allEntries.sort((a, b) => b.score - a.score);

            for (let i = 0; i < allEntries.length; i++) {
                const entryScore = allEntries[i].score;

                // If the current entry's score is different from the last processed score,
                // it means we've moved to a new rank group.
                if (entryScore !== lastScore) {
                    currentRank = i + 1; 
                }
                
                // If the player's score is equal to the current entry's score,
                // then the player's rank is the current rank.
                // We break because we found the highest rank for this score.
                if (playerScore === entryScore) {
                    playerRank = currentRank;
                    break; 
                } 
                // If the player's score is greater than the current entry's score,
                // it means the player ranks above this entry. Their rank is the current rank.
                // We break because we found the player's rank.
                else if (playerScore > entryScore) {
                    playerRank = currentRank;
                    break; 
                }
                
                lastScore = entryScore; // Update lastScore for the next iteration
            }

            // Edge case: If the player's score is lower than all existing scores,
            // their rank is after everyone.
            if (allEntries.length > 0 && playerScore < allEntries[allEntries.length - 1].score) {
                playerRank = allEntries.length + 1;
            }
            // Edge case: If there are no entries, the player is rank 1.
            if (allEntries.length === 0) {
                playerRank = 1;
            }

            showGameOverModal(playerScore, playerRank, mode);

        } catch (error) {
            console.error("Erro ao calcular ranking: ", error);
            alert("Erro ao calcular sua posi√ß√£o no ranking.");
            showMainMenu(); // Fallback to main menu
        }
    }

    // Fun√ß√£o para processar uma resposta correta
    function processCorrectAnswer() {
        score++;
        correctAnswersCount++; 
        scoreValueElement.textContent = score;
        scoreValueElement.classList.add('pulse-effect');
        scoreValueElement.addEventListener('animationend', function handler() {
            scoreValueElement.classList.remove('pulse-effect');
            scoreValueElement.removeEventListener('animationend', handler);
        });

        answerInput.classList.add('correct-input-anim'); 
        questionElement.classList.add('correct-animation'); 
        if (isSoundOn) correctSound.play();

        const timeTaken = (Date.now() - questionStartTime) / 1000; 
        const speedBonusThreshold = 1.5; 
        const bonusTime = 0.5; 

        if (timeTaken <= speedBonusThreshold) {
            timeLeft = Math.min(60, timeLeft + bonusTime); 
            timerValueElement.textContent = Math.ceil(timeLeft) + 's'; 
        }
        
        answerInput.addEventListener('animationend', function handler() {
            answerInput.classList.remove('correct-input-anim');
            answerInput.removeEventListener('animationend', handler);
        });
        questionElement.addEventListener('animationend', function handler() {
            questionElement.classList.remove('correct-animation');
            questionElement.removeEventListener('animationend', handler);
        });

        explainConceptButton.style.display = 'inline-block';

        setTimeout(() => {
            generateQuestion();
        }, 300); 
    }

    // Fun√ß√£o para processar uma resposta incorreta (apenas feedback visual, sem avan√ßo)
    function processIncorrectAnswer() {
        scoreValueElement.textContent = score; // Atualiza para garantir que n√£o pulsa se o score n√£o mudou
        scoreValueElement.classList.add('pulse-effect');
        scoreValueElement.addEventListener('animationend', function handler() {
            scoreValueElement.classList.remove('pulse-effect');
            scoreValueElement.removeEventListener('animationend', handler);
        });

        answerInput.classList.add('incorrect-input-anim'); 
        questionElement.classList.add('incorrect-animation'); 
        if (isSoundOn) incorrectSound.play();
        
        answerInput.addEventListener('animationend', function handler() {
            answerInput.classList.remove('incorrect-input-anim');
            answerInput.removeEventListener('animationend', handler);
        });
        questionElement.addEventListener('animationend', function handler() {
            questionElement.classList.remove('incorrect-animation');
            questionElement.removeEventListener('animationend', handler);
        });

        explainConceptButton.style.display = 'inline-block';

        // N√£o gera nova pergunta aqui, o usu√°rio precisa apagar e corrigir
        // setTimeout(() => {
        //     generateQuestion();
        // }, 300);
    }


    // --- Event Listeners ---
    practiceButton.addEventListener('click', showOperationSelection); 
    competitionButton.addEventListener('click', showCompetitionModeSelection); 

    backToMainFromOperationButton.addEventListener('click', showMainMenu); 
    backToOperationSelectionButton.addEventListener('click', showOperationSelection); 
    backToMainFromCompetitionModeButton.addEventListener('click', showMainMenu); 
    backToMainFromRankingButton.addEventListener('click', showMainMenu);

    document.querySelectorAll('#operation-selection-container .operation-buttons button').forEach(button => {
        button.addEventListener('click', (e) => {
            selectOperation(e.target.dataset.op);
        });
    });

    modeKidsButton.addEventListener('click', (e) => selectGameModeAndStart(e.target.dataset.mode));
    modeAdultsButton.addEventListener('click', (e) => selectGameModeAndStart(e.target.dataset.mode));

    document.querySelectorAll('#competition-mode-selection-container .competition-buttons button[data-mode^="competition_"]').forEach(button => {
        button.addEventListener('click', (e) => selectGameModeAndStart(e.target.dataset.mode));
    });

    // Event listeners para o modal de Game Over
    viewFullRankingButton.addEventListener('click', () => {
        hideGameOverModal();
        showRankingsScreen();
    });

    gameOverMainMenuButton.addEventListener('click', () => {
        hideGameOverModal();
        showMainMenu();
        currentGameMode = null; // Reset mode
        selectedOperationType = 'all'; // Reset operation
        questionElement.textContent = 'Selecione um modo e digite seu nome para come√ßar!';
        difficultyLevelElement.textContent = '';
        numericKeypad.style.display = 'none';
    });


    startGameButton.addEventListener('click', () => startGame());
    playAgainButton.addEventListener('click', () => startGame());

    playerNameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            startGame();
        }
    });

    numericKeypad.addEventListener('click', (e) => {
        if (!gameActive) return;

        const target = e.target;
        if (target.tagName === 'BUTTON') {
            const value = target.dataset.value;

            if (value === 'clear') {
                answerInput.value = '';
                // Limpa quaisquer anima√ß√µes ou estilos de feedback visual
                answerInput.classList.remove('correct', 'incorrect', 'correct-input-anim', 'incorrect-input-anim');
                questionElement.classList.remove('correct-animation', 'incorrect-animation');
                messageElement.textContent = ''; // Garante que a mensagem est√° vazia
            } else {
                // Para evitar m√∫ltiplos zeros no in√≠cio (e.g. 005)
                // Se o input est√° vazio e o primeiro d√≠gito √© zero, apenas define como '0'
                // Se j√° √© '0', n√£o adiciona outro '0'
                // Sen√£o, concatena o valor
                if (answerInput.value === '' && value === '0') {
                    answerInput.value = '0';
                } else if (answerInput.value === '0' && value !== '0') {
                    answerInput.value = value;
                }
                else {
                    answerInput.value += value;
                }
                
                const userAnswer = Number(answerInput.value);
                const correctAnswer = currentQuestion.answer;

                // Se a resposta do usu√°rio √© exatamente igual √† resposta correta, processa como correto
                if (userAnswer === correctAnswer) {
                    processCorrectAnswer();
                } else {
                    // Se o usu√°rio digitou algo, mas n√£o √© a resposta correta,
                    // aplica a anima√ß√£o de incorreto, mas N√ÉO avan√ßa a pergunta.
                    // O usu√°rio ter√° que apagar e corrigir.
                    // Limpa quaisquer anima√ß√µes ou estilos de feedback visual anteriores
                    answerInput.classList.remove('correct', 'incorrect', 'correct-input-anim', 'incorrect-input-anim');
                    questionElement.classList.remove('correct-animation', 'incorrect-animation');
                    messageElement.textContent = ''; // Garante que a mensagem est√° vazia

                    // Aplica a anima√ß√£o de "incorreto" para feedback visual imediato
                    // sem avan√ßar a pergunta.
                    answerInput.classList.add('incorrect-input-anim');
                    questionElement.classList.add('incorrect-animation');
                    if (isSoundOn) incorrectSound.play();

                    // Remove as classes de anima√ß√£o ap√≥s a conclus√£o para que possam ser reativadas
                    answerInput.addEventListener('animationend', function handler() {
                        answerInput.classList.remove('incorrect-input-anim');
                        answerInput.removeEventListener('animationend', handler);
                    });
                    questionElement.addEventListener('animationend', function handler() {
                        questionElement.classList.remove('incorrect-animation');
                        questionElement.removeEventListener('animationend', handler);
                    });
                }
            }
        }
    });

    answerInput.addEventListener('focus', (e) => {
        e.target.blur();
    });

    settingsIcon.addEventListener('click', showSettingsModal);
    closeSettingsModalButton.addEventListener('click', hideSettingsModal);

    toggleSound.addEventListener('click', () => { isSoundOn = handleToggle(toggleSound, isSoundOn); });
    toggleBGM.addEventListener('click', () => { isBGMOn = handleToggle(toggleBGM, isBGMOn); });
    toggleVibration.addEventListener('click', () => { isVibrationOn = handleToggle(toggleVibration, isVibrationOn); });

    settingsHomeButton.addEventListener('click', () => {
        hideSettingsModal();
        endGame(); 
    });

    settingsReplayButton.addEventListener('click', () => {
        hideSettingsModal();
        clearInterval(timerInterval); 
        gameActive = false; 
        score = 0;
        timeLeft = 60;
        correctAnswersCount = 0;
        scoreValueElement.textContent = score;
        timerValueElement.textContent = timeLeft + 's';
        playerNameInput.style.display = 'none'; 
        answerInput.style.display = 'inline-block'; 
        answerInput.disabled = false; 
        numericKeypad.style.display = 'grid'; 
        timeBar.style.width = '100%';
        timeBar.style.backgroundColor = '#4CAF50';
        timeBar.classList.remove('time-bar-shaking');
        explainConceptButton.style.display = 'none'; 
        generateQuestion(); 
        timerInterval = setInterval(() => { 
            timeLeft--;
            timerValueElement.textContent = timeLeft + 's';
            const percentage = (timeLeft / 60) * 100;
            timeBar.style.width = percentage + '%';
            if (percentage > 50) {
                timeBar.style.backgroundColor = '#4CAF50';
            } else if (percentage > 20) {
                timeBar.style.backgroundColor = '#FFC107';
                if (timeLeft <= 10 && !timeBar.classList.contains('time-bar-shaking')) {
                    timeBar.classList.add('time-bar-shaking');
                }
            } else {
                timeBar.style.backgroundColor = '#DC3545';
                if (timeLeft <= 10 && !timeBar.classList.contains('time-bar-shaking')) {
                    timeBar.classList.add('time-bar-shaking');
                    void timeBar.offsetWidth;
                }
            }
            if (timeLeft <= 0) {
                endGame();
            }
        }, 1000);
    });

    settingsMoreButton.addEventListener('click', () => {
        alert("Funcionalidade 'Mais Op√ß√µes' em desenvolvimento!");
        hideSettingsModal();
    });

    explainConceptButton.addEventListener('click', showExplanationModal);
    closeExplanationModalButton.addEventListener('click', hideExplanationModal);
    explanationOkButton.addEventListener('click', hideExplanationModal);

    window.onload = () => {
        // Garante que o teclado num√©rico est√° oculto logo no carregamento da p√°gina
        numericKeypad.style.display = 'none'; 
        showSplashScreen();
    };

  </script>
</body>
</html>
