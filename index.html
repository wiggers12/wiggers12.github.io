<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Desafio dos 60 Segundos üß†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9968425306160320"
          crossorigin="anonymous"></script>
  
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      margin: 0;
      background-color: #f4f4f4;
      color: #333;
      padding: 20px;
      box-sizing: border-box;
    }

    h1 {
      color: #4CAF50;
      margin-bottom: 20px;
    }

    /* Anima√ß√£o de entrada para os cont√™ineres principais */
    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.95) translateY(20px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    /* Anima√ß√£o de pulso para feedback de score/tempo */
    @keyframes pulseEffect {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    /* Anima√ß√£o de shake para barra de tempo */
    @keyframes timeShake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-2px); }
        20%, 40%, 60%, 80% { transform: translateX(2px); }
    }

    #game-container, .ranking-section, #challenge-area, #mode-selection { /* Adicionado #mode-selection */
      background-color: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      text-align: center;
      width: 90%;
      max-width: 500px;
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
      opacity: 0; /* Come√ßa invis√≠vel para a anima√ß√£o */
      transform: scale(0.95) translateY(20px); /* Posi√ß√£o inicial para a anima√ß√£o */
      animation: fadeInScale 0.7s ease-out forwards; /* Aplica a anima√ß√£o */
    }

    #mode-selection {
        animation-delay: 0.2s; /* Primeiro a aparecer */
        padding-bottom: 15px;
    }
    #game-container {
        animation-delay: 0.4s;
    }
    #challenge-area {
        background-color: #f0f0f0; /* Fundo diferente para a √°rea de desafio */
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05); /* Sombra interna */
        animation-delay: 0.6s;
        display: none; /* Esconda inicialmente at√© o JS mostrar */
    }
    .ranking-section { /* Aplica para ambas as se√ß√µes de ranking */
        animation-delay: 0.8s;
    }


    #challenge-area h3 {
        color: #007bff;
        margin-bottom: 15px;
    }
    #challenge-code-display {
        font-size: 1.5em;
        font-weight: bold;
        color: #4CAF50;
        margin-bottom: 10px;
        word-break: break-all; /* Quebra texto longo */
    }
    #share-link-display {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 15px;
        word-break: break-all;
    }
    #challenge-code-input {
        padding: 10px;
        font-size: 1.1em;
        width: calc(100% - 22px);
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        text-align: center;
    }

    #question-area {
      margin-bottom: 20px;
    }

    #difficulty-level {
        font-size: 0.9em;
        color: #777;
        margin-bottom: 10px;
    }

    #question {
      font-size: 2em;
      margin-bottom: 15px;
      color: #555;
      transition: color 0.3s ease, transform 0.3s ease; /* Transi√ß√£o para cor e posi√ß√£o */
    }

    #question.correct-animation {
        animation: pulseGreen 0.5s ease-out;
    }
    #question.incorrect-animation {
        animation: shakeRed 0.5s ease-out;
    }

    #answer-input, #player-name-input {
      padding: 10px;
      font-size: 1.2em;
      width: calc(100% - 22px);
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      text-align: center;
      transition: border-color 0.3s ease, transform 0.1s ease;
    }

    #player-name-input {
        margin-bottom: 20px;
    }

    #answer-input.correct {
      border-color: #28a745;
      box-shadow: 0 0 5px rgba(40, 167, 69, 0.5);
    }

    #answer-input.incorrect {
      border-color: #d9534f;
      box-shadow: 0 0 5px rgba(217, 83, 79, 0.5);
    }

    #answer-input.correct-input-anim {
        animation: bounceIn 0.3s forwards;
    }
    #answer-input.incorrect-input-anim {
        animation: shake 0.5s ease-out;
    }

    button {
      background-color: #007bff;
      color: white;
      padding: 12px 25px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1.1em;
      transition: background-color 0.3s ease, transform 0.1s ease, box-shadow 0.3s ease;
      margin: 5px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    button:hover {
      background-color: #0056b3;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    button:active {
      transform: translateY(1px);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    /* Cores espec√≠ficas para bot√µes de desafio */
    #copy-challenge-button, #play-challenge-button, #generate-challenge-button {
        background-color: #17a2b8; /* Cor secund√°ria para desafios */
    }
    #copy-challenge-button:hover, #play-challenge-button:hover, #generate-challenge-button:hover {
        background-color: #138496;
    }
    /* Cores para bot√µes de sele√ß√£o de modo */
    #mode-kids-button, #mode-adults-button {
        background-color: #6c757d; /* Cor neutra inicial */
    }
    #mode-kids-button.active, #mode-adults-button.active {
        background-color: #4CAF50; /* Verde quando ativo */
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.5); /* Anel verde */
    }
    #mode-kids-button:hover, #mode-adults-button:hover {
        background-color: #5a6268;
    }


    #message {
      margin-top: 15px;
      font-weight: bold;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    #message.show {
        opacity: 1;
    }
    #message.correct-text {
        color: #28a745;
    }
    #message.incorrect-text {
        color: #d9534f;
    }
    #message.speed-bonus-text {
        color: #007bff;
        animation: fadeInOut 1.5s forwards;
    }

    #timer, #score {
      font-size: 1.2em;
      margin: 10px 0;
      color: #666;
    }

    #timer-value, #score-value {
      font-weight: bold;
      color: #4CAF50;
      transition: color 0.3s ease; /* Transi√ß√£o para mudan√ßa de cor */
    }
    #timer-value.pulse-effect, #score-value.pulse-effect {
        animation: pulseEffect 0.3s ease-out;
    }


    #start-game-button { /* Renomeado */
      background-color: #28a745;
      padding: 15px 30px;
      font-size: 1.3em;
    }

    #start-game-button:hover {
      background-color: #218838;
    }

    .ranking-section h2 { /* Aplica para ambos os h2 de ranking */
      color: #4CAF50;
      margin-bottom: 15px;
    }

    .ranking-list { /* Aplica para ambas as ol de ranking */
      list-style: none;
      padding: 0;
      text-align: left;
    }

    .ranking-list li {
      padding: 8px 0;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .ranking-list li:last-child {
      border-bottom: none;
    }

    .ranking-position {
      font-weight: bold;
      color: #007bff;
      min-width: 25px;
    }

    .ranking-name {
      flex-grow: 1;
      margin-left: 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .ranking-score {
      font-weight: bold;
      color: #333;
      min-width: 40px;
      text-align: right;
    }

    /* Cores para os Top 3 */
    .ranking-list li.ranking-item-top .ranking-name,
    .ranking-list li.ranking-item-top .ranking-score {
        color: #007bff;
    }

    /* Cores para os 3 √öltimos */
    .ranking-list li.ranking-item-bottom .ranking-name,
    .ranking-list li.ranking-item-bottom .ranking-score {
        color: #d9534f;
    }

    #time-bar-container {
      width: 100%;
      height: 10px;
      background-color: #ddd;
      border-radius: 5px;
      margin-bottom: 15px;
      overflow: hidden;
    }

    #time-bar {
      height: 100%;
      width: 100%;
      background-color: #4CAF50;
      border-radius: 5px;
      transition: width 0.9s linear, background-color 0.9s linear, transform 0.1s ease;
    }
    .time-bar-shaking {
        animation: timeShake 0.5s ease-out infinite;
    }

    #answer-input {
        display: none;
    }

    /* Keyframes para as anima√ß√µes */
    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-5px); }
      100% { transform: translateX(0); }
    }

    @keyframes bounceIn {
      0% { transform: scale(0.9); opacity: 0; }
      50% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); }
    }

    @keyframes pulseGreen {
        0% { transform: scale(1); color: #555; }
        50% { transform: scale(1.05); color: #28a745; }
        100% { transform: scale(1); color: #555; }
    }

    @keyframes shakeRed {
        0% { transform: translateX(0); color: #555; }
        25% { transform: translateX(-5px); color: #d9534f; }
        50% { transform: translateX(5px); color: #d9534f; }
        75% { transform: translateX(-5px); color: #d9534f; }
        100% { transform: translateX(0); color: #555; }
    }

    @keyframes fadeInOut {
        0% { opacity: 0; transform: translateY(10px); }
        20% { opacity: 1; transform: translateY(0); }
        80% { opacity: 1; transform: translateY(0); }
        100% { opacity: 0; transform: translateY(-10px); }
    }

    @media (max-width: 600px) {
      #game-container, .ranking-section, #challenge-area, #mode-selection {
        padding: 20px;
      }
      #question {
        font-size: 1.5em;
      }
      #answer-input, #player-name-input, button {
        font-size: 1em;
        padding: 10px 20px;
      }
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

</head>
<body>
  <h1>Desafio dos 60 Segundos üß†</h1>

  <div id="mode-selection">
    <h3>Escolha o Modo de Jogo:</h3>
    <button id="mode-kids-button">Modo Crian√ßas</button>
    <button id="mode-adults-button">Modo Adultos</button>
  </div>

  <div id="game-container">
    <div id="status">
      <p id="timer">Tempo: <span id="timer-value">60s</span></p>
      <div id="time-bar-container">
          <div id="time-bar"></div>
      </div>
      <p id="score">Pontos: <span id="score-value">0</span></p>
    </div>

    <div id="question-area">
      <p id="difficulty-level"></p> 
      <p id="question">Selecione um modo e digite seu nome para come√ßar!</p>
      <input type="text" id="player-name-input" placeholder="Seu nome" maxlength="20" pattern="[A-Za-z√Ä-√∫\s]+" title="Apenas letras e espa√ßos s√£o permitidos.">
      <input type="number" id="answer-input" placeholder="Digite a resposta">
      <p id="message"></p>
    </div>

    <button id="submit-answer" style="display: none;">Responder</button>
    <button id="start-game-button" style="display: none;">Come√ßar Jogo</button> <button id="play-again" style="display: none;">Jogar Novamente</button>
  </div>

  <div id="challenge-area">
    <h3>Desafie um Amigo! (<span id="challenge-mode-display"></span>)</h3>
    <button id="generate-challenge-button">Gerar Novo Desafio</button>
    <p id="challenge-code-display" style="display: none;"></p>
    <p id="share-link-display" style="display: none;"></p>
    <button id="copy-challenge-button" style="display: none;">Copiar C√≥digo</button>
    <hr style="margin: 20px 0; border: none; border-top: 1px dashed #ccc;">
    <h3>Entrar em um Desafio Existente</h3>
    <input type="text" id="challenge-code-input" placeholder="C√≥digo do Desafio" maxlength="10">
    <button id="play-challenge-button">Jogar Desafio</button>
  </div>


  <div id="ranking-kids-area" class="ranking-section">
    <h2>üèÜ Ranking Crian√ßas (Top 20)</h2>
    <ol id="ranking-kids-list" class="ranking-list">
    </ol>
  </div>

  <div id="ranking-adults-area" class="ranking-section">
    <h2>üèÜ Ranking Adultos (Top 20)</h2>
    <ol id="ranking-adults-list" class="ranking-list">
    </ol>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA4PWRt-22S8HGc6GS1m-4Wa9hYsh5Zbo",
      authDomain: "desafio-dos-60-segundos.firebaseapp.com",
      projectId: "desafio-dos-60-segundos",
      storageBucket: "desafio-dos-60-segundos.firebaseapp.com",
      messagingSenderId: "1054471364887",
      appId: "1:1054471364887:web:332b4f28814e9f5d0cd752",
      measurementId: "G-N4PWJ72YCJ"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = app.firestore(); 

    const questionElement = document.getElementById('question');
    const answerInput = document.getElementById('answer-input');
    const playerNameInput = document.getElementById('player-name-input');
    const submitAnswerButton = document.getElementById('submit-answer');
    const messageElement = document.getElementById('message');
    const timerValueElement = document.getElementById('timer-value');
    const scoreValueElement = document.getElementById('score-value');
    const startGameButton = document.getElementById('start-game-button'); // ID Renomeado
    const playAgainButton = document.getElementById('play-again');
    const timeBar = document.getElementById('time-bar');
    const difficultyLevelElement = document.getElementById('difficulty-level'); 

    // Elementos de Modo de Jogo
    const modeKidsButton = document.getElementById('mode-kids-button');
    const modeAdultsButton = document.getElementById('mode-adults-button');
    let currentGameMode = null; // 'kids' ou 'adults'

    // Elementos de Ranking
    const rankingKidsList = document.getElementById('ranking-kids-list');
    const rankingAdultsList = document.getElementById('ranking-adults-list');

    // Elementos de desafio
    const challengeArea = document.getElementById('challenge-area');
    const generateChallengeButton = document.getElementById('generate-challenge-button');
    const challengeCodeDisplay = document.getElementById('challenge-code-display');
    const shareLinkDisplay = document.getElementById('share-link-display');
    const copyChallengeButton = document.getElementById('copy-challenge-button');
    const challengeCodeInput = document.getElementById('challenge-code-input');
    const playChallengeButton = document.getElementById('play-challenge-button');
    const challengeModeDisplay = document.getElementById('challenge-mode-display');


    let currentQuestion;
    let score = 0;
    let timeLeft = 60;
    let timerInterval;
    let gameActive = false;
    let currentDifficulty = 1;
    let currentPlayerName = '';
    let questionStartTime; 
    let currentChallengeCode = null;

    const correctSound = new Audio('correct.mp3');
    const incorrectSound = new Audio('incorrect.mp3');

    const difficultyNames = {
        1: "Iniciante",
        2: "Aprendiz",
        3: "Intermedi√°rio",
        4: "Avan√ßado",
        5: "Mestre",
        6: "G√™nio Matem√°tico"
    };

    // --- Fun√ß√µes de Ajuda para o Desafio (e gerador de sementes) ---

    function generateUniqueCode(length = 6) {
        const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let result = '';
        for (let i = 0; i < length; i++) {
            result += characters.charAt(Math.floor(Math.random() * characters.length));
        }
        return result;
    }

    let seed = Date.now();
    function random() {
        var x = Math.sin(seed++) * 10000;
        return x - Math.floor(x);
    }
    function seededRandomInt(min, max) {
        return Math.floor(random() * (max - min + 1)) + min;
    }
    function stringToHash(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash |= 0;
        }
        return Math.abs(hash);
    }

    // --- Fun√ß√µes do Jogo ---

    function selectGameMode(mode) {
        currentGameMode = mode;
        console.log("Modo de jogo selecionado:", currentGameMode);
        
        // Atualiza o estado dos bot√µes
        modeKidsButton.classList.remove('active');
        modeAdultsButton.classList.remove('active');
        if (mode === 'kids') {
            modeKidsButton.classList.add('active');
        } else {
            modeAdultsButton.classList.add('active');
        }

        // Mostra o bot√£o de come√ßar jogo e input de nome
        startGameButton.style.display = 'inline-block';
        playerNameInput.style.display = 'inline-block';
        playerNameInput.focus();
        questionElement.textContent = 'Digite seu nome e clique em "Come√ßar Jogo"!';
        
        // Atualiza a exibi√ß√£o do modo de desafio
        challengeModeDisplay.textContent = mode === 'kids' ? 'Modo Crian√ßas' : 'Modo Adultos';

        // Atualiza os rankings
        displayRanking('kids');
        displayRanking('adults');
    }

    function saveRanking(player, score, mode) {
        const collectionName = `ranking_${mode}`;
        db.collection(collectionName).add({
            player: player,
            score: score,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then((docRef) => {
            console.log("Documento escrito com ID: ", docRef.id);
            displayRanking(mode); // Atualiza o ranking espec√≠fico
        })
        .catch((error) => {
            console.error("Erro ao adicionar documento: ", error);
            alert("Erro ao salvar pontua√ß√£o. Por favor, tente novamente mais tarde.");
        });
    }

    async function displayRanking(mode) {
        const rankingListElement = mode === 'kids' ? rankingKidsList : rankingAdultsList;
        const collectionName = `ranking_${mode}`;

        rankingListElement.innerHTML = '<li>Carregando ranking...</li>';

        try {
            const snapshot = await db.collection(collectionName)
                                            .orderBy("score", "desc")
                                            .limit(20) 
                                            .get();
            rankingListElement.innerHTML = '';
            if (snapshot.empty) {
                rankingListElement.innerHTML = '<li>Nenhum recorde ainda. Seja o primeiro!</li>';
                return;
            }

            const rankings = [];
            snapshot.forEach((doc) => {
                rankings.push(doc.data());
            });

            rankings.forEach((data, index) => {
                const li = document.createElement('li');
                const rankingPosition = index + 1;

                const positionSpan = `<span class="ranking-position">${rankingPosition}¬∫</span>`;
                const nameSpan = `<span class="ranking-name">${data.player}</span>`;
                const scoreSpan = `<span class="ranking-score">${data.score}</span>`;
                
                li.innerHTML = `${positionSpan} ${nameSpan} ${scoreSpan}`;
                
                // Marca os 3 primeiros
                if (rankingPosition <= 3) {
                    li.classList.add('ranking-item-top'); 
                }
                // Marca os 3 √∫ltimos (se houver pelo menos 4 itens no ranking)
                if (rankings.length >= 4 && rankingPosition > rankings.length - 3) {
                    const startIndexForBottom = Math.max(0, rankings.length - 3); 
                    if (index >= startIndexForBottom) {
                        li.classList.add('ranking-item-bottom');
                    }
                }

                rankingListElement.appendChild(li);
            });

        } catch (error) {
            console.error(`Erro ao carregar ranking ${mode}: `, error);
            rankingListElement.innerHTML = '<li>Erro ao carregar ranking.</li>';
            alert(`Erro ao carregar ranking ${mode}. Verifique o console para mais detalhes.`);
        }
    }

    function generateQuestion() {
      let num1, num2;
      let operators; 
      let operator;
      let correctAnswer;

      if (currentGameMode === 'kids') {
          operators = ['+', '-'];
          currentDifficulty = Math.min(currentDifficulty, 3); // Limita a dificuldade para crian√ßas
          num1 = seededRandomInt(1, 10 + currentDifficulty * 5); // Aumenta um pouco com dificuldade
          num2 = seededRandomInt(1, 10 + currentDifficulty * 5);
      } else { // Adults mode
          operators = ['+', '-', '*', '√∑'];
          if (currentDifficulty === 1) {
            num1 = seededRandomInt(1, 10);
            num2 = seededRandomInt(1, 10);
          } else if (currentDifficulty === 2) {
            num1 = seededRandomInt(1, 20);
            num2 = seededRandomInt(1, 20);
          } else if (currentDifficulty === 3) {
            num1 = seededRandomInt(1, 30);
            num2 = seededRandomInt(1, 30);
          } else if (currentDifficulty === 4) {
            num1 = seededRandomInt(1, 50);
            num2 = seededRandomInt(1, 50);
          } else if (currentDifficulty === 5) {
            num1 = seededRandomInt(1, 70);
            num2 = seededRandomInt(1, 70);
          } else { 
            num1 = seededRandomInt(1, 100);
            num2 = seededRandomInt(1, 100);
          }
      }
      
      operator = operators[Math.floor(random() * operators.length)];


      let questionString;

      if (operator === '+') {
        questionString = `${num1} + ${num2}`;
        correctAnswer = num1 + num2;
      } else if (operator === '-') {
        if (num1 < num2) { 
          questionString = `${num2} - ${num1}`;
          correctAnswer = num2 - num1;
        } else {
          questionString = `${num1} - ${num2}`;
          correctAnswer = num1 - num2;
        }
      } else if (operator === '*') {
        questionString = `${num1} * ${num2}`;
        correctAnswer = num1 * num2;
      } else { // Divis√£o '√∑'
        let tempNum1, tempNum2;
        if (currentGameMode === 'kids') { // Crian√ßas n√£o fazem divis√£o t√£o complexa
            tempNum1 = seededRandomInt(1, 5);
            tempNum2 = seededRandomInt(1, 5);
        } else {
            if (currentDifficulty < 5) { 
                tempNum1 = seededRandomInt(1, 5); 
                tempNum2 = seededRandomInt(1, 5);
            } else {
                tempNum1 = seededRandomInt(1, 10); 
                tempNum2 = seededRandomInt(1, 10);
            }
        }
       
        num1 = tempNum1 * tempNum2; 
        num2 = tempNum2;
        
        if (num2 === 0) num2 = 1;

        questionString = `${num1} √∑ ${num2}`;
        correctAnswer = num1 / num2;
      }

      currentQuestion = { question: questionString, answer: correctAnswer };
      questionElement.textContent = currentQuestion.question;
      difficultyLevelElement.textContent = `N√≠vel: ${difficultyNames[currentDifficulty] || 'Desconhecido'} (${currentGameMode === 'kids' ? 'Crian√ßas' : 'Adultos'})`; 
      answerInput.value = '';
      messageElement.textContent = '';
      answerInput.classList.remove('correct', 'incorrect', 'correct-input-anim', 'incorrect-input-anim');
      questionElement.classList.remove('correct-animation', 'incorrect-animation');
      messageElement.classList.remove('show', 'correct-text', 'incorrect-text', 'speed-bonus-text'); 
      
      questionStartTime = Date.now(); 
    }

    function startGame(challengeCode = null, challengeMode = null) {
      if (!currentGameMode && !challengeMode) {
          alert("Por favor, selecione um modo de jogo (Crian√ßas ou Adultos) antes de come√ßar.");
          return;
      }
      // Se estamos iniciando um desafio, o modo do desafio sobrescreve o modo selecionado
      if (challengeMode) {
        currentGameMode = challengeMode;
        selectGameMode(currentGameMode); // Atualiza os bot√µes de modo
      }

      currentPlayerName = playerNameInput.value.trim();
      
      if (!playerNameInput.checkValidity()) {
        alert(playerNameInput.title);
        playerNameInput.focus();
        return;
      }
      if (currentPlayerName === '') {
        alert("Por favor, digite seu nome para come√ßar o jogo!");
        playerNameInput.focus();
        return;
      }

      if (challengeCode) {
          currentChallengeCode = challengeCode.toUpperCase();
          seed = stringToHash(currentChallengeCode);
          console.log(`Iniciando desafio com c√≥digo: ${currentChallengeCode}, semente: ${seed}, modo: ${currentGameMode}`);
      } else {
          currentChallengeCode = null;
          seed = Date.now();
          console.log("Iniciando jogo normal com nova semente.");
      }

      score = 0;
      timeLeft = 60;
      gameActive = true;
      currentDifficulty = 1;
      scoreValueElement.textContent = score;
      timerValueElement.textContent = timeLeft + 's';
      
      playerNameInput.style.display = 'none';
      answerInput.style.display = 'inline-block';
      answerInput.disabled = false;
      answerInput.focus();
      
      questionElement.textContent = 'Preparar...';
      difficultyLevelElement.textContent = ''; 
      
      startGameButton.style.display = 'none';
      submitAnswerButton.style.display = 'inline-block';
      playAgainButton.style.display = 'none';
      
      // Esconder a √°rea de sele√ß√£o de modo e √°rea de desafio ao iniciar o jogo
      document.getElementById('mode-selection').style.display = 'none';
      challengeArea.style.display = 'none';

      timeBar.style.width = '100%';
      timeBar.style.backgroundColor = '#4CAF50';
      timeBar.classList.remove('time-bar-shaking');

      setTimeout(() => {
        generateQuestion();
        timerInterval = setInterval(() => {
          timeLeft--;
          timerValueElement.textContent = timeLeft + 's';
          
          const percentage = (timeLeft / 60) * 100;
          timeBar.style.width = percentage + '%';

          if (percentage > 50) {
              timeBar.style.backgroundColor = '#4CAF50';
          } else if (percentage > 20) {
              timeBar.style.backgroundColor = '#FFC107';
              if (timeLeft <= 10 && !timeBar.classList.contains('time-bar-shaking')) {
                  timeBar.classList.add('time-bar-shaking');
              }
          } else {
              timeBar.style.backgroundColor = '#DC3545';
              if (timeLeft <= 10 && !timeBar.classList.contains('time-bar-shaking')) {
                  timeBar.classList.add('time-bar-shaking');
              }
          }

          if (timeLeft <= 0) {
            endGame();
          }
        }, 1000);
      }, 1000);
    }

    function endGame() {
      clearInterval(timerInterval);
      gameActive = false;
      answerInput.disabled = true;
      submitAnswerButton.style.display = 'none';
      playAgainButton.style.display = 'inline-block';
      messageElement.textContent = `Tempo esgotado! Voc√™ fez ${score} pontos.`;
      messageElement.classList.add('show'); 
      messageElement.classList.remove('correct-text', 'incorrect-text', 'speed-bonus-text'); 
      
      answerInput.classList.remove('correct', 'incorrect', 'correct-input-anim', 'incorrect-input-anim');
      questionElement.classList.remove('correct-animation', 'incorrect-animation');
      timeBar.classList.remove('time-bar-shaking');

      if (currentChallengeCode) {
          saveChallengeScore(currentPlayerName, score, currentChallengeCode, currentGameMode); // Salva o modo do desafio
      } else {
          saveRanking(currentPlayerName, score, currentGameMode); // Salva no ranking espec√≠fico
      }
      
      playerNameInput.value = '';
      playerNameInput.style.display = 'inline-block';
      answerInput.style.display = 'none';
      questionElement.textContent = 'Selecione um modo e digite seu nome para come√ßar!';
      difficultyLevelElement.textContent = ''; 
      
      // Mostrar a √°rea de sele√ß√£o de modo e √°rea de desafio novamente
      document.getElementById('mode-selection').style.display = 'block';
      challengeArea.style.display = 'block';
    }

    function checkAnswer() {
      if (!gameActive) return;

      const userAnswer = parseInt(answerInput.value);
      if (isNaN(userAnswer)) {
        messageElement.textContent = 'Por favor, digite um n√∫mero!';
        messageElement.classList.add('show', 'incorrect-text'); 
        answerInput.classList.add('incorrect-input-anim'); 
        incorrectSound.play();
        
        answerInput.addEventListener('animationend', function handler() {
            answerInput.classList.remove('incorrect-input-anim');
            answerInput.removeEventListener('animationend', handler);
        });

        return;
      }

      if (userAnswer === currentQuestion.answer) {
        score++;
        scoreValueElement.textContent = score;
        scoreValueElement.classList.add('pulse-effect');
        scoreValueElement.addEventListener('animationend', function handler() {
            scoreValueElement.classList.remove('pulse-effect');
            scoreValueElement.removeEventListener('animationend', handler);
        });

        messageElement.textContent = 'Correto!';
        messageElement.classList.add('show', 'correct-text'); 
        answerInput.classList.add('correct-input-anim'); 
        questionElement.classList.add('correct-animation'); 
        correctSound.play();

        const timeTaken = (Date.now() - questionStartTime) / 1000; 
        const speedBonusThreshold = 1.5; 
        const bonusTime = 0.5; 

        if (timeTaken <= speedBonusThreshold) {
            timeLeft = Math.min(60, timeLeft + bonusTime); 
            timerValueElement.textContent = Math.ceil(timeLeft) + 's'; 
            messageElement.textContent += " (WOW! R√°pido! +0.5s)";
            messageElement.classList.add('speed-bonus-text'); 
        }

        // Dificuldade para crian√ßas sobe mais devagar ou at√© um limite
        if (currentGameMode === 'kids') {
            if (score > 0 && score % 3 === 0 && currentDifficulty < 3) { // Mais r√°pido para subir dificuldade, mas limitado
                currentDifficulty++;
                console.log(`Dificuldade crian√ßas aumentada para: ${currentDifficulty}`);
                messageElement.textContent += ` (Dificuldade: ${difficultyNames[currentDifficulty]}!)`;
            }
        } else { // Adultos
            if (score > 0 && score % 5 === 0) {
                currentDifficulty++;
                console.log(`Dificuldade adultos aumentada para: ${currentDifficulty}`);
                messageElement.textContent += ` (Dificuldade: ${difficultyNames[currentDifficulty]}!)`;
            }
        }
        

        answerInput.addEventListener('animationend', function handler() {
            answerInput.classList.remove('correct-input-anim');
            answerInput.removeEventListener('animationend', handler);
        });
        questionElement.addEventListener('animationend', function handler() {
            questionElement.classList.remove('correct-animation');
            questionElement.removeEventListener('animationend', handler);
        });
        messageElement.addEventListener('animationend', function handler() { 
            messageElement.classList.remove('speed-bonus-text');
            messageElement.removeEventListener('animationend', handler);
        });

        setTimeout(() => {
            generateQuestion();
        }, 500); 
        
      } else {
        score = Math.max(0, score - 1); 
        scoreValueElement.textContent = score;
        scoreValueElement.classList.add('pulse-effect');
        scoreValueElement.addEventListener('animationend', function handler() {
            scoreValueElement.classList.remove('pulse-effect');
            scoreValueElement.removeEventListener('animationend', handler);
        });

        messageElement.textContent = 'Errado. Tente novamente.';
        messageElement.classList.add('show', 'incorrect-text'); 
        answerInput.classList.add('incorrect-input-anim'); 
        questionElement.classList.add('incorrect-animation'); 
        incorrectSound.play();
        
        answerInput.addEventListener('animationend', function handler() {
            answerInput.classList.remove('incorrect-input-anim');
            answerInput.removeEventListener('animationend', handler);
        });
        questionElement.addEventListener('animationend', function handler() {
            questionElement.classList.remove('incorrect-animation');
            questionElement.removeEventListener('animationend', handler);
        });

        setTimeout(() => {
            answerInput.classList.remove('correct', 'incorrect', 'correct-input-anim', 'incorrect-input-anim');
            questionElement.classList.remove('correct-animation', 'incorrect-animation');
        }, 500);
      }
    }

    // --- Fun√ß√µes de Desafio ---

    function handleGenerateChallenge() {
        if (!currentGameMode) {
            alert("Por favor, selecione um modo de jogo (Crian√ßas ou Adultos) antes de gerar um desafio.");
            return;
        }

        const newChallengeCode = generateUniqueCode();
        currentChallengeCode = newChallengeCode;
        challengeCodeDisplay.textContent = newChallengeCode;
        challengeCodeDisplay.style.display = 'block';

        const shareUrl = window.location.origin + window.location.pathname + `?challenge=${newChallengeCode}&mode=${currentGameMode}`;
        shareLinkDisplay.textContent = `Link para compartilhar: ${shareUrl}`;
        shareLinkDisplay.style.display = 'block';

        copyChallengeButton.style.display = 'inline-block';
        
        db.collection("challenges").doc(newChallengeCode).set({
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            mode: currentGameMode // Salva o modo do desafio
        })
        .then(() => {
            console.log(`Desafio ${newChallengeCode} registrado no modo ${currentGameMode}.`);
            alert(`Desafio ${newChallengeCode} gerado no modo ${currentGameMode}! Compartilhe este c√≥digo/link com seu amigo:\n\nC√≥digo: ${newChallengeCode}\nLink: ${shareUrl}`);
        })
        .catch(error => {
            console.error("Erro ao registrar desafio:", error);
            alert("Erro ao gerar desafio. Tente novamente.");
        });
    }

    function handleCopyChallengeCode() {
        if (shareLinkDisplay.textContent) { // Copia o link completo para facilitar
            navigator.clipboard.writeText(shareLinkDisplay.textContent.replace('Link para compartilhar: ', '')).then(() => {
                alert('Link do desafio copiado para a √°rea de transfer√™ncia!');
            }).catch(err => {
                console.error('Falha ao copiar: ', err);
                alert('Falha ao copiar o link. Tente copiar manualmente: ' + shareLinkDisplay.textContent);
            });
        } else {
            alert("Nenhum desafio gerado ainda para copiar.");
        }
    }

    async function handlePlayChallenge() {
        const code = challengeCodeInput.value.trim();
        if (code.length === 6 && /^[A-Z0-9]+$/.test(code)) {
            // Verifica o modo do desafio no Firebase antes de iniciar
            try {
                const doc = await db.collection("challenges").doc(code).get();
                if (doc.exists && doc.data().mode) {
                    const challengeMode = doc.data().mode;
                    startGame(code, challengeMode); // Inicia o jogo com o c√≥digo e o modo do desafio
                } else {
                    alert("C√≥digo de desafio inv√°lido ou modo n√£o especificado para este desafio.");
                }
            } catch (error) {
                console.error("Erro ao verificar c√≥digo de desafio:", error);
                alert("Erro ao verificar c√≥digo de desafio. Tente novamente.");
            }
        } else {
            alert("Por favor, insira um c√≥digo de desafio v√°lido (6 letras/n√∫meros mai√∫sculos).");
            challengeCodeInput.focus();
        }
    }

    async function saveChallengeScore(player, score, challengeCode, mode) {
        try {
            const challengeRef = db.collection("challengeResults").doc(challengeCode);
            await challengeRef.set({
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                mode: mode, // Salva o modo junto com os resultados do desafio
                players: firebase.firestore.FieldValue.arrayUnion({
                    name: player,
                    score: score,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                })
            }, { merge: true });

            console.log(`Pontua√ß√£o de ${player} (${score} pts) registrada para desafio ${challengeCode} no modo ${mode}.`);
            displayChallengeResults(challengeCode, mode);

        } catch (error) {
            console.error("Erro ao salvar pontua√ß√£o do desafio:", error);
            alert("Erro ao salvar sua pontua√ß√£o no desafio. Verifique o console.");
        }
    }

    async function displayChallengeResults(challengeCode, mode) {
        try {
            const doc = await db.collection("challengeResults").doc(challengeCode).get();
            if (doc.exists && doc.data().mode === mode) {
                const data = doc.data();
                if (data.players && data.players.length > 0) {
                    let resultsMessage = `Resultados do Desafio "${challengeCode}" (${mode === 'kids' ? 'Crian√ßas' : 'Adultos'}):\n\n`;
                    data.players.sort((a, b) => b.score - a.score);
                    data.players.forEach((p, index) => {
                        resultsMessage += `${index + 1}¬∫ - ${p.name}: ${p.score} pontos\n`;
                    });
                    alert(resultsMessage);
                } else {
                    alert("Nenhum resultado encontrado para este desafio ainda.");
                }
            } else {
                alert("Desafio n√£o encontrado ou modo de jogo incompat√≠vel.");
            }
        } catch (error) {
            console.error("Erro ao carregar resultados do desafio:", error);
            alert("Erro ao carregar resultados do desafio.");
        }
    }


    // --- Event Listeners ---
    modeKidsButton.addEventListener('click', () => selectGameMode('kids'));
    modeAdultsButton.addEventListener('click', () => selectGameMode('adults'));

    startGameButton.addEventListener('click', () => startGame(null, currentGameMode)); // Passa o modo atual
    submitAnswerButton.addEventListener('click', checkAnswer);
    playAgainButton.addEventListener('click', () => startGame(null, currentGameMode));

    playerNameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            startGame(null, currentGameMode);
        }
    });

    answerInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        checkAnswer();
      }
    });

    generateChallengeButton.addEventListener('click', handleGenerateChallenge);
    copyChallengeButton.addEventListener('click', handleCopyChallengeCode);
    playChallengeButton.addEventListener('click', handlePlayChallenge);
    challengeCodeInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            handlePlayChallenge();
        }
    });


    window.onload = () => {
        // Inicializa os rankings
        displayRanking('kids');
        displayRanking('adults');
        
        // Esconde o bot√£o de iniciar jogo inicialmente
        startGameButton.style.display = 'none';
        playerNameInput.style.display = 'none';
        answerInput.style.display = 'none';
        difficultyLevelElement.textContent = ''; 

        // Mostra a √°rea de sele√ß√£o de modo e desafio
        document.getElementById('mode-selection').style.display = 'block';
        challengeArea.style.display = 'block';
        challengeModeDisplay.textContent = 'Aguardando sele√ß√£o'; // Texto inicial para o modo de desafio

        // Verifica se h√° um c√≥digo de desafio na URL
        const urlParams = new URLSearchParams(window.location.search);
        const challengeFromUrl = urlParams.get('challenge');
        const modeFromUrl = urlParams.get('mode');

        if (challengeFromUrl && modeFromUrl) {
            challengeCodeInput.value = challengeFromUrl;
            selectGameMode(modeFromUrl); // Seleciona o modo automaticamente se vier da URL
            alert(`C√≥digo de desafio encontrado na URL: "${challengeFromUrl}" no Modo ${modeFromUrl === 'kids' ? 'Crian√ßas' : 'Adultos'}. Digite seu nome e clique em 'Jogar Desafio'.`);
        }
    };

  </script>
</body>
</html>